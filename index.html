<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PG Live Diary</title>
  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* ãƒ„ã‚¢ãƒ¼åˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
    .tour-group { margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
    .tour-header { background: #eee; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; }
    .tour-body { background: white; display: none; padding: 10px; }
    .tour-body.open { display: block; }

    /* ã‚«ãƒ¼ãƒ‰UI */
    .card { border-bottom: 1px solid #eee; padding: 10px 0; }
    .card:last-child { border-bottom: none; }
    .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
    .btn-add { background: var(--primary); color: white; }
    .btn-del { background: #666; color: white; }
    .btn-edit { background: #007bff; color: white; margin-top: 10px; }
    
    /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    .song-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; align-items: center; }
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary2</h1></header>

<div id="tab-search" class="tab-content active">
  <h3>ãƒ©ã‚¤ãƒ–ã‚’æ¢ã—ã¦ç™»éŒ²</h3>
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn" onclick="exportBackup()">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
  <p>ãƒªã‚¹ãƒˆã‚¢ï¼š<input type="file" onchange="importBackup(this)"></p>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <h3 id="modal-title">ã‚»ãƒˆãƒªç™»éŒ²</h3>
    <div id="current-setlist" style="margin-bottom: 20px;"></div>
    <hr>
    <h4>æ›²ã‚’è¿½åŠ </h4>
    <input type="text" id="song-search" placeholder="æ›²åã‚’æ¤œç´¢..." oninput="searchSongs(this.value)" style="width:100%; padding:10px; box-sizing:border-box;">
    <div id="search-results" style="max-height: 200px; overflow-y: auto; margin-top:10px;"></div>
    <button class="btn" onclick="closeModal()" style="background:#333; color:white; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let editingLiveId = null;

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives;
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) {
      document.getElementById('master-live-list').innerHTML = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }

  // --- ãƒ„ã‚¢ãƒ¼åˆ¥è¡¨ç¤º ---
  function renderMasterList() {
    const container = document.getElementById('master-live-list');
    const groups = {};
    masterLives.forEach(l => {
      if (!groups[l.title]) groups[l.title] = [];
      groups[l.title].push(l);
    });

    container.innerHTML = Object.keys(groups).map(title => `
      <div class="tour-group">
        <div class="tour-header" onclick="this.nextElementSibling.classList.toggle('open')">
          ${title} <span>â–¼</span>
        </div>
        <div class="tour-body">
          ${groups[title].map(live => {
            const isAttended = userData.attendedIds.includes(live.id);
            return `
              <div class="card">
                <small>${live.date}</small> <b>${live.venue}</b>
                <button class="btn ${isAttended ? 'btn-del' : 'btn-add'}" onclick="toggleAttend('${live.id}')">
                  ${isAttended ? 'å–æ¶ˆ' : 'å‚æˆ¦ç™»éŒ²'}
                </button>
              </div>`;
          }).join('')}
        </div>
      </div>
    `).join('');
  }

  function toggleAttend(id) {
    if (userData.attendedIds.includes(id)) {
      userData.attendedIds = userData.attendedIds.filter(i => i !== id);
    } else {
      userData.attendedIds.push(id);
    }
    saveUserData();
  }

  // --- å±¥æ­´è¡¨ç¤º ---
  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
    
    container.innerHTML = myLives.map(l => `
      <div class="card" style="border:1px solid #ddd; padding:15px; border-radius:10px; margin-bottom:15px;">
        <b>${l.date}</b><br>${l.title}<br><small>${l.venue}</small>
        <button class="btn btn-edit" onclick="openEditModal('${l.id}')">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ç·¨é›†</button>
        <div style="margin-top:10px; font-size:0.85em; color:#444;">
          ${(userData.customSetlists[l.id] || []).map((s, i) => `<div>${i+1}. ${getSongTitle(s)}</div>`).join('')}
        </div>
      </div>
    `).join('');
  }

  function getSongTitle(songId) {
    const s = masterSongs.find(sm => sm.id == songId);
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  // --- ã‚»ãƒˆãƒªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
  function openEditModal(liveId) {
    editingLiveId = liveId;
    const live = masterLives.find(l => l.id == liveId);
    document.getElementById('modal-title').textContent = live.date + " ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ";
    renderCurrentSetlist();
    document.getElementById('edit-modal').style.display = 'block';
  }

  function renderCurrentSetlist() {
    const list = userData.customSetlists[editingLiveId] || [];
    document.getElementById('current-setlist').innerHTML = list.map((songId, index) => `
      <div class="song-item">
        <span>${index+1}. ${getSongTitle(songId)}</span>
        <button onclick="removeSong(${index})" style="color:red; border:none; background:none;">å‰Šé™¤</button>
      </div>
    `).join('') || "æ›²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
  }

  function searchSongs(query) {
    const results = document.getElementById('search-results');
    if (!query) { results.innerHTML = ""; return; }
    const filtered = masterSongs.filter(s => s.title.includes(query)).slice(0, 10);
    results.innerHTML = filtered.map(s => `
      <div class="song-item" onclick="addSong('${s.id}')" style="cursor:pointer; background:#f9f9f9; margin-top:2px;">
        <span>${s.title}</span> <span style="color:blue;">ï¼‹è¿½åŠ </span>
      </div>
    `).join('');
  }

  function addSong(songId) {
    if (!userData.customSetlists[editingLiveId]) userData.customSetlists[editingLiveId] = [];
    userData.customSetlists[editingLiveId].push(songId);
    renderCurrentSetlist();
    saveUserData();
  }

  function removeSong(index) {
    userData.customSetlists[editingLiveId].splice(index, 1);
    renderCurrentSetlist();
    saveUserData();
  }

  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

  // --- çµ±è¨ˆ ---
  function renderMyStats() {
    const counts = {};
    Object.values(userData.customSetlists).forEach(list => {
      list.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    document.getElementById('my-stats-area').innerHTML = "<h4>Myæ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>" + 
      (sorted.map(([id, count]) => `<div>${getSongTitle(id)} : ${count}å›</div>`).join('') || "ã‚»ãƒˆãƒªã‚’ç™»éŒ²ã™ã‚‹ã¨é›†è¨ˆã•ã‚Œã¾ã™ã€‚");
  }

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ã¯å‰å›åŒæ§˜
  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup.json`;
    a.click();
  }
  function importBackup(input) {
    const reader = new FileReader();
    reader.onload = () => { userData = JSON.parse(reader.result); saveUserData(); alert("å¾©å…ƒã—ã¾ã—ãŸ"); };
    reader.readAsText(input.files[0]);
  }

  init();
</script>
</body>
</html>
