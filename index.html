<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PG Live Diary</title>
  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 60px; }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* ã‚«ãƒ¼ãƒ‰UI */
    .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
    .btn-add { background: var(--primary); color: white; }
    .btn-del { background: #666; color: white; }
    
    /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }

    /* åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .ad-space { background: #ddd; text-align: center; padding: 10px; font-size: 10px; color: #999; margin: 10px 0; }
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary2</h1></header>

<div class="ad-space">ADVERTISEMENT</div>

<div id="tab-search" class="tab-content active">
  <h3>ãƒ©ã‚¤ãƒ–ã‚’æ¢ã—ã¦ç™»éŒ²</h3>
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area">å‚æˆ¦ãƒ­ã‚°ã‚’ç™»éŒ²ã™ã‚‹ã¨é›†è¨ˆã•ã‚Œã¾ã™ã€‚</div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®šãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
  <button class="btn" onclick="exportBackup()">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSONä¿å­˜)</button>
  <p>ãƒªã‚¹ãƒˆã‚¢ï¼š<input type="file" onchange="importBackup(this)"></p>
  <hr>
  <button class="btn btn-del" onclick="clearAllData()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')">å±¥æ­´</button>
  <button onclick="showTab('stats')">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let masterSetlists = [];
  let userData = {
    attendedIds: [], // å‚æˆ¦ã—ãŸãƒ©ã‚¤ãƒ–IDã®ãƒªã‚¹ãƒˆ
    customSetlists: {} // ç‹¬è‡ªã«ç·¨é›†ã—ãŸã‚»ãƒˆãƒªãŒã‚ã‚Œã°ä¿å­˜
  };

  async function init() {
    try {
      // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆsetlists.json ã®èª­ã¿è¾¼ã¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼‰
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => { if(!r.ok) throw new Error(); return r.json(); }),
        fetch('songs_master.json').then(r => { if(!r.ok) throw new Error(); return r.json(); })
      ]);

      masterLives = resLives;
      masterSongs = resSongs;
      masterSetlists = []; // ç©ºã®é…åˆ—ã¨ã—ã¦åˆæœŸåŒ–
      
      loadUserData();
      renderAll();
      
      // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’æ¶ˆã™ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
      document.getElementById('master-live-list').innerHTML = ""; 
      renderMasterList(); 
      
    } catch (e) {
      console.error("Data Load Error:", e);
      document.getElementById('master-live-list').innerHTML = 
        `<p style="color:red;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
    }
  }


  // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† ---
  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    event.currentTarget.classList.add('active');
  }

  // --- ãƒ¡ã‚¤ãƒ³æç”» ---
  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }

  // ãƒ©ã‚¤ãƒ–ä¸€è¦§ã®è¡¨ç¤º
  function renderMasterList() {
    const container = document.getElementById('master-live-list');
    container.innerHTML = masterLives.map(live => {
      const isAttended = userData.attendedIds.includes(live.id);
      return `
        <div class="card">
          <b>${live.date}</b><br>${live.title}<br><small>${live.venue}</small>
          <button class="btn ${isAttended ? 'btn-del' : 'btn-add'}" onclick="toggleAttend('${live.id}')">
            ${isAttended ? 'âŒ å‚æˆ¦è§£é™¤' : 'â• å‚æˆ¦ç™»éŒ²'}
          </button>
        </div>
      `;
    }).join('');
  }

  function toggleAttend(id) {
    if (userData.attendedIds.includes(id)) {
      userData.attendedIds = userData.attendedIds.filter(i => i !== id);
    } else {
      userData.attendedIds.push(id);
    }
    saveUserData();
  }

  // ãƒã‚¤å±¥æ­´ã®è¡¨ç¤º
  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
    if(myLives.length === 0) { container.innerHTML = "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
    
    container.innerHTML = myLives.map(l => `
      <div class="card">
        <b>${l.date}</b><br>${l.title}
        <div style="font-size:0.8em; margin-top:5px; color:#666;">
          ${getSetlistPreview(l.id)}
        </div>
      </div>
    `).join('');
  }

  function getSetlistPreview(liveId) {
    const set = masterSetlists.filter(s => s.live_id === liveId);
    return set.length > 0 ? `å…¨${set.length}æ›² æ¼”å¥` : "ã‚»ãƒˆãƒªæœªç™»éŒ²";
  }

  // çµ±è¨ˆï¼šè‡ªåˆ†ãŒè´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  function renderMyStats() {
    const container = document.getElementById('my-stats-area');
    const mySongCounts = {};
    
    userData.attendedIds.forEach(liveId => {
      const set = masterSetlists.filter(s => s.live_id === liveId);
      set.forEach(s => {
        mySongCounts[s.song_id] = (mySongCounts[s.song_id] || 0) + 1;
      });
    });

    const sorted = Object.entries(mySongCounts).sort((a,b) => b[1] - a[1]);
    let html = "<h4>ğŸ¤ è‡ªåˆ†ãŒç”Ÿã§è´ã„ãŸå›æ•°</h4>";
    sorted.slice(0, 10).forEach(([id, count]) => {
      const song = masterSongs.find(s => s.id == id);
      html += `<div>${song ? song.title : id}: ${count}å›</div>`;
    });
    container.innerHTML = html || "å‚æˆ¦ãƒ­ã‚°ã‚’å¢—ã‚„ã™ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒå‡ºã¾ã™ã€‚";
  }

  // --- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ ---
  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  }

  function importBackup(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      userData = JSON.parse(reader.result);
      saveUserData();
      alert("ãƒªã‚¹ãƒˆã‚¢å®Œäº†ï¼");
    };
    reader.readAsText(file);
  }

  function clearAllData() {
    if(confirm("å…¨ã¦ã®å‚æˆ¦è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      userData = { attendedIds: [], customSetlists: {} };
      saveUserData();
    }
  }

  init();
</script>
</body>
</html>

