<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>
  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* å¹´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }

    /* ãƒ„ã‚¢ãƒ¼åˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }

    /* ãƒ©ã‚¤ãƒ–é …ç›®ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .card:last-child { border-bottom: none; }
    .live-info { font-size: 0.9em; }
    .live-date { color: #888; font-size: 0.8em; margin-right: 5px; }

    /* å°ã•ã„ãƒœã‚¿ãƒ³ */
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    
    /* iPhoneã‚ºãƒ¼ãƒ å¯¾ç­–ï¼šãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’16pxä»¥ä¸Šã«è¨­å®š */
    #song-search {
      font-size: 16px !important;
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .song-item { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #eee; align-items: center; }
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary5</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn-edit" onclick="exportBackup()" style="background:#666;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
  <div style="margin-top:20px;">
    <label style="font-size: 0.9em; color: #666;">ãƒªã‚¹ãƒˆã‚¢ï¼š</label>
    <input type="file" onchange="importBackup(this)">
  </div>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <div id="current-setlist"></div>
    <hr>
    <h4>æ›²ã‚’è¿½åŠ </h4>
    <input type="text" id="song-search" placeholder="æ›²åã‚’æ¤œç´¢..." oninput="searchSongs(this.value)">
    <div id="search-results" style="max-height: 250px; overflow-y: auto;"></div>
    <button class="btn-mini" onclick="closeModal()" style="background:#333; color:white; width:100%; padding:10px; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let editingLiveId = null;

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) { console.error(e); }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }

  function renderMasterList() {
    const container = document.getElementById('master-live-list');
    const years = {};

    masterLives.forEach(l => {
      const year = l.date.substring(0, 4);
      if (!years[year]) years[year] = {};
      if (!years[year][l.title]) years[year][l.title] = [];
      years[year][l.title].push(l);
    });

    const sortedYears = Object.keys(years).sort((a, b) => b - a);

    container.innerHTML = sortedYears.map(year => `
      <div class="year-section">
        <div class="year-label">${year}å¹´</div>
        ${Object.keys(years[year]).map(title => `
          <div class="tour-group">
            <div class="tour-header" onclick="toggleTour(event, this)">
              <span>${title}</span>
              <span style="font-size:0.7em; color:#999;">â–¼</span>
            </div>
            <div class="tour-body">
              ${years[year][title].map(live => {
                const isAttended = userData.attendedIds.includes(live.id);
                return `
                  <div class="card">
                    <div class="live-info">
                      <span class="live-date">${live.date.substring(5).replace('-', '/')}</span>
                      <span>${live.venue}</span>
                    </div>
                    <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'}" 
                            onclick="handleToggleAttend(event, '${live.id}')">
                      ${isAttended ? 'âœ…' : 'ï¼‹'}
                    </button>
                  </div>`;
              }).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    `).join('');
  }

  // --- é–‹é–‰ç”¨é–¢æ•°ï¼ˆã‚¬ãƒ¼ãƒ‰ã‚’å¼·åŒ–ï¼‰ ---
  // 1. ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ã‚’å—ã‘æŒã¤é–¢æ•°
  function toggleTour(event, header) {
    // ã€é‡è¦ã€‘ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´æ‰€ãŒã€Œtour-bodyï¼ˆãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã‚¨ãƒªã‚¢ï¼‰ã€ã®ä¸­ã ã£ãŸã‚‰ã€
    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã‚‹å‡¦ç†ã‚’ã•ã›ãšã«çµ‚äº†ã™ã‚‹
    if (event.target.closest('.tour-body')) {
      return;
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã ã‘é–‹é–‰ã™ã‚‹
    const body = header.nextElementSibling;
    body.classList.toggle('open');
  }

  // 2. ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆï¼‹ã‚„âœ…ï¼‰ã‚’æŠ¼ã—ãŸæ™‚ã«å‹•ãé–¢æ•°
  function handleToggleAttend(event, id) {
    // è¦ªè¦ç´ ã¸ã®ã‚¯ãƒªãƒƒã‚¯ä¼é”ã‚’æ­¢ã‚ã‚‹ï¼ˆå¿µã®ãŸã‚ï¼‰
    if (event && event.stopPropagation) {
      event.stopPropagation();
    }
    
    // å®Ÿéš›ã®ç™»éŒ²å‡¦ç†ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ãŸã‚Šå¤–ã—ãŸã‚Šï¼‰ã‚’å®Ÿè¡Œ
    toggleAttend(id);
  }



  function toggleAttend(id) {
    if (userData.attendedIds.includes(id)) {
      const live = masterLives.find(l => l.id == id);
      const hasSetlist = userData.customSetlists[id] && userData.customSetlists[id].length > 0;
      
      let message = `ã€Œ${live.venue}ã€ã®å‚æˆ¦ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`;
      if (hasSetlist) {
        message += "\nâ€»ç™»éŒ²æ¸ˆã¿ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
      }

      if (confirm(message)) {
        userData.attendedIds = userData.attendedIds.filter(i => i !== id);
        if (userData.customSetlists[id]) {
          delete userData.customSetlists[id];
        }
        saveUserData();
      }
    } else {
      userData.attendedIds.push(id);
      saveUserData();
    }
  }

  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
    container.innerHTML = myLives.map(l => `
      <div class="card" style="display:block; border:1px solid #ddd; padding:15px; border-radius:10px; margin-bottom:15px; background:white;">
        <div style="font-size:0.8em; color:#888;">${l.date}</div>
        <div style="font-weight:bold; margin-bottom:5px;">${l.title}</div>
        <div style="font-size:0.9em;">${l.venue}</div>
        <button class="btn-edit" onclick="openEditModal('${l.id}')">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ç·¨é›†</button>
        <div style="margin-top:10px; font-size:0.85em; color:#666; line-height:1.4;">
          ${(userData.customSetlists[l.id] || []).map((s, i) => `${i+1}. ${getSongTitle(s)} `).join('')}
        </div>
      </div>
    `).join('');
  }

  function getSongTitle(songId) {
    const s = masterSongs.find(sm => sm.id == songId);
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  function openEditModal(liveId) {
    editingLiveId = liveId;
    const live = masterLives.find(l => l.id == liveId);
    document.getElementById('modal-title').textContent = live.date + " ã‚»ãƒˆãƒª";
    renderCurrentSetlist();
    document.getElementById('edit-modal').style.display = 'block';
  }

  function renderCurrentSetlist() {
    const list = userData.customSetlists[editingLiveId] || [];
    document.getElementById('current-setlist').innerHTML = list.map((songId, index) => `
      <div class="song-item">
        <span>${index+1}. ${getSongTitle(songId)}</span>
        <button onclick="removeSong(${index})" style="color:red; border:none; background:none;">å‰Šé™¤</button>
      </div>
    `).join('') || "æœªç™»éŒ²";
  }

  function searchSongs(query) {
    const results = document.getElementById('search-results');
    if (!query) { results.innerHTML = ""; return; }
    const filtered = masterSongs.filter(s => s.title.includes(query)).slice(0, 10);
    results.innerHTML = filtered.map(s => `
      <div class="song-item" onclick="addSong('${s.id}')" style="cursor:pointer; background:#f9f9f9; margin-top:2px;">
        <span>${s.title}</span> <span style="color:blue;">ï¼‹</span>
      </div>
    `).join('');
  }

  function addSong(songId) {
    if (!userData.customSetlists[editingLiveId]) userData.customSetlists[editingLiveId] = [];
    userData.customSetlists[editingLiveId].push(songId);
    renderCurrentSetlist();
    saveUserData();
  }

  function removeSong(index) {
    userData.customSetlists[editingLiveId].splice(index, 1);
    renderCurrentSetlist();
    saveUserData();
  }

  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

  function renderMyStats() {
    const counts = {};
    Object.values(userData.customSetlists).forEach(list => {
      list.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    document.getElementById('my-stats-area').innerHTML = "<h4>Myæ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>" + 
      (sorted.map(([id, count]) => `<div>${getSongTitle(id)} : ${count}å›</div>`).join('') || "å±¥æ­´ã‹ã‚‰ã‚»ãƒˆãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }

  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup.json`;
    a.click();
  }

  function importBackup(input) {
    const reader = new FileReader();
    reader.onload = () => { userData = JSON.parse(reader.result); saveUserData(); alert("å¾©å…ƒå®Œäº†"); };
    reader.readAsText(input.files[0]);
  }

  init();
</script>

</body>
</html>
