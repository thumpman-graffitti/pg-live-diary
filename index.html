<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>

  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* å¹´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }

    /* ãƒ„ã‚¢ãƒ¼åˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }

    /* ãƒ©ã‚¤ãƒ–é …ç›®ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .card:last-child { border-bottom: none; }
    .live-info { font-size: 0.9em; }
    .live-date { color: #888; font-size: 0.8em; margin-right: 5px; }

    /* å°ã•ã„ãƒœã‚¿ãƒ³ */
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    
    /* iPhoneã‚ºãƒ¼ãƒ å¯¾ç­– */
    #song-search { font-size: 16px !important; width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
    .song-item { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #eee; align-items: center; }

    /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    .my-log-card { display: block !important; padding: 10px 12px !important; margin-bottom: 8px !important; background: white; border-radius: 6px; border: 1px solid #ddd; }
    .log-title-row { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; }
    .log-date { font-size: 0.8em; color: #888; font-family: monospace; }
    .log-title { font-weight: bold; font-size: 1em; color: var(--primary); flex: 1; }
    .log-venue { font-size: 0.85em; color: #333; margin-bottom: 8px; }
    .log-actions { display: flex; gap: 5px; border-top: 1px dashed #eee; padding-top: 8px; }
    .btn-view-setlist { background: #f0f0f0; color: #333; flex: 2; }
    .btn-edit-icon { background: #666; color: white; flex: 1; }
    .setlist-collapse { display: none; background: #fdfdfd; margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 0.85em; color: #555; border-left: 2px solid #ccc; line-height: 1.5; }
    .setlist-collapse.open { display: block; }        

    /* --- çµ±è¨ˆãƒšãƒ¼ã‚¸ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    .stats-summary-header { background: #333; color: white; text-align: center; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1.1em; margin-bottom: 15px; }
    
    .stats-card { background: white; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .stats-card h5 { margin: 0 0 8px 0; color: var(--primary); border-bottom: 2px solid #f4f4f4; padding-bottom: 4px; font-size: 0.9em; }

    .stat-row-group { border-bottom: 1px solid #f2f2f2; padding: 4px 0; }
    .stat-row { display: flex; align-items: center; padding: 0; font-size: 0.85em; cursor: pointer; }
    .stat-rank { width: 25px; font-size: 0.75em; color: #aaa; font-weight: bold; }
    .stat-name { flex: 1; color: var(--primary); text-decoration: underline; font-weight: bold; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stat-count { min-width: 35px; text-align: right; color: var(--primary); font-size: 0.9em; font-weight: bold; }

    .stat-last-date { font-size: 0.65em; color: #888; margin-left: 25px; margin-top: -1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-bottom: 2px; }

    /* ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ */
    .btn-more { width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; color: #666; font-weight: bold; cursor: pointer; margin: 5px 0 15px 0; font-size: 0.85em; }

    /* æœªé­é‡æ›²ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ  */
    .unheard-scroll-container { max-height: 150px; overflow-y: auto; background: #fafafa; border-radius: 6px; border: 1px solid #eee; padding: 8px; }
    .unheard-list { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; }
    .unheard-item { font-size: 0.72em; color: #888; padding: 3px 0; border-bottom: 1px solid #f0f0f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .unheard-item::before { content: "â€¢ "; color: #ccc; }
  </style>


</head>
<body>

<header><h1>ğŸ¸ PG Live Diary9</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn-edit" onclick="exportBackup()" style="background:#666;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
  <div style="margin-top:20px;">
    <label style="font-size: 0.9em; color: #666;">ãƒªã‚¹ãƒˆã‚¢ï¼š</label>
    <input type="file" onchange="importBackup(this)">
  </div>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <div id="current-setlist"></div>
    <hr>
    <h4>æ›²ã‚’è¿½åŠ </h4>
    <input type="text" id="song-search" placeholder="æ›²åã‚’æ¤œç´¢..." oninput="searchSongs(this.value)">
    <div id="search-results" style="max-height: 250px; overflow-y: auto;"></div>
    <button class="btn-mini" onclick="closeModal()" style="background:#333; color:white; width:100%; padding:10px; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let editingLiveId = null;

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) { console.error(e); }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }


function renderMasterList() {
  const container = document.getElementById('master-live-list');
  const years = {};

  masterLives.forEach(l => {
    const year = l.date.substring(0, 4);
    if (!years[year]) years[year] = {};
    if (!years[year][l.title]) years[year][l.title] = [];
    years[year][l.title].push(l);
  });

  const sortedYears = Object.keys(years).sort((a, b) => b - a);

  container.innerHTML = sortedYears.map(year => `
    <div class="year-section">
      <div class="year-label">${year}å¹´</div>
      ${Object.keys(years[year]).map(title => `
        <div class="tour-group">
          <div class="tour-header" onclick="toggleTour(event, this)">
            <span>${title}</span>
            <span style="font-size:0.7em; color:#999; pointer-events:none;">â–¼</span>
          </div>
          <div class="tour-body">
            ${years[year][title].map(live => {
              const isAttended = userData.attendedIds.includes(live.id);
              return `
                <div class="card">
                  <div class="live-info">
                    <span class="live-date">${live.date.substring(5).replace('-', '/')}</span>
                    <span>${live.venue}</span>
                  </div>
                  <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'} js-attend-btn" 
                          data-id="${live.id}"
                          onclick="handleToggleAttend(event, '${live.id}')">
                    ${isAttended ? 'âœ…' : 'ï¼‹'}
                  </button>
                </div>`;
            }).join('')}
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function toggleTour(event, header) {
  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯çµ¶å¯¾ã«å‹•ã‹ã•ãªã„
  if (event.target.closest('button')) return;
  
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}




// ãƒœã‚¿ãƒ³ã«ç›´æ¥ã€Œã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç„¡è¦–ã™ã‚‹ã€è¨­å®šã‚’æµã—è¾¼ã‚€
function attachButtonEvents() {
  const btns = document.querySelectorAll('.js-attend-btn');
  btns.forEach(btn => {
    btn.onclick = function(e) {
      // 1. è¦ªã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼é”ã‚’å¾¹åº•çš„ã«æ‹’å¦
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const liveId = this.getAttribute('data-id');
      toggleAttend(liveId);
      
      // 2. ã“ã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ false ã«ã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®é€£é–ã‚’æ­¢ã‚ã‚‹
      return false;
    };
  });
}

// ã“ã¡ã‚‰ã®é–¢æ•°ã‚‚ã“ã‚Œã ã‘ã«ç°¡ç•¥åŒ–
function handleToggleAttend(event, id) {
  // HTMLå´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã“ã¨ã¯ãªããªã‚Šã¾ã™ãŒã€å®šç¾©ã ã‘æ®‹ã—ã¦ãŠãã¾ã™
  if (event) event.stopPropagation();
  toggleAttend(id);
}

function toggleAttend(id) {
  // 1. ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
  const index = userData.attendedIds.indexOf(id);
  if (index > -1) {
    const live = masterLives.find(l => l.id == id);
    const hasSetlist = userData.customSetlists[id] && userData.customSetlists[id].length > 0;
    let message = `ã€Œ${live.venue}ã€ã®å‚æˆ¦ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    if (hasSetlist) message += "\nâ€»ç™»éŒ²æ¸ˆã¿ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
    
    if (!confirm(message)) return;

    userData.attendedIds.splice(index, 1);
    delete userData.customSetlists[id];
  } else {
    userData.attendedIds.push(id);
  }

  // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆrenderAllã¯å‘¼ã°ãªã„ï¼‰
  localStorage.setItem('pg_user_diary', JSON.stringify(userData));

  // 3. ã€é‡è¦ã€‘ç”»é¢å…¨ä½“ã‚’å†æç”»ã›ãšã€æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã ã‘ã‚’æ›¸ãæ›ãˆã‚‹
  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn) {
    const isAttended = userData.attendedIds.includes(id);
    btn.className = `btn-mini ${isAttended ? 'btn-del' : 'btn-add'} js-attend-btn`;
    btn.innerHTML = isAttended ? 'âœ…' : 'ï¼‹';
  }
  
  // 4. ä»–ã®ã‚¿ãƒ–ï¼ˆå±¥æ­´ã‚„çµ±è¨ˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚è£ã§æ›´æ–°ã—ã¦ãŠã
  renderMyHistory();
  renderMyStats();
}

// å±¥æ­´ãƒšãƒ¼ã‚¸ã®æ›´æ–°
function renderMyHistory() {
  const container = document.getElementById('my-history-list');
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  
  // 1ç•ªä¸Šã«å‚æˆ¦å›æ•°ã‚’è¡¨ç¤º
  let html = `<div class="stats-summary-header">Total Lives: ${myLives.length}</div>`;

  if (myLives.length === 0) {
    container.innerHTML = html + "ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  html += myLives.map(l => {
    const setlist = userData.customSetlists[l.id] || [];
    return `
      <div class="card my-log-card">
        <div class="log-main-info">
          <div class="log-title-row">
            <span class="log-date">${l.date.substring(2).replace(/-/g, '/')}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div class="log-venue">${l.venue}</div>
        </div>
        <div class="log-actions">
          <button class="btn-mini btn-view-setlist" onclick="toggleSetlistDisplay('${l.id}')">
            ğŸ“Š ã‚»ãƒˆãƒª ${setlist.length > 0 ? `(${setlist.length})` : ''}
          </button>
          <button class="btn-mini btn-edit-icon" onclick="openEditModal('${l.id}')">âœï¸ ç·¨é›†</button>
        </div>
        <div id="setlist-view-${l.id}" class="setlist-collapse">
          <div class="setlist-content">
            ${setlist.length > 0 
              ? setlist.map((s, i) => `<div>${i+1}. ${getSongTitle(s)}</div>`).join('')
              : '<span style="color:#999;">ã‚»ãƒˆãƒªæœªç™»éŒ²</span>'}
          </div>
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = html;
}



// ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°ï¼ˆæ–°è¨­ï¼‰
function toggleSetlistDisplay(id) {
  const el = document.getElementById(`setlist-view-${id}`);
  el.classList.toggle('open');
}

 

  function getSongTitle(songId) {
    const s = masterSongs.find(sm => sm.id == songId);
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  function openEditModal(liveId) {
    editingLiveId = liveId;
    const live = masterLives.find(l => l.id == liveId);
    document.getElementById('modal-title').textContent = live.date + " ã‚»ãƒˆãƒª";
    renderCurrentSetlist();
    document.getElementById('edit-modal').style.display = 'block';
  }

  function renderCurrentSetlist() {
    const list = userData.customSetlists[editingLiveId] || [];
    document.getElementById('current-setlist').innerHTML = list.map((songId, index) => `
      <div class="song-item">
        <span>${index+1}. ${getSongTitle(songId)}</span>
        <button onclick="removeSong(${index})" style="color:red; border:none; background:none;">å‰Šé™¤</button>
      </div>
    `).join('') || "æœªç™»éŒ²";
  }

  function searchSongs(query) {
    const results = document.getElementById('search-results');
    if (!query) { results.innerHTML = ""; return; }
    const filtered = masterSongs.filter(s => s.title.includes(query)).slice(0, 10);
    results.innerHTML = filtered.map(s => `
      <div class="song-item" onclick="addSong('${s.id}')" style="cursor:pointer; background:#f9f9f9; margin-top:2px;">
        <span>${s.title}</span> <span style="color:blue;">ï¼‹</span>
      </div>
    `).join('');
  }

  function addSong(songId) {
    if (!userData.customSetlists[editingLiveId]) userData.customSetlists[editingLiveId] = [];
    userData.customSetlists[editingLiveId].push(songId);
    renderCurrentSetlist();
    saveUserData();
  }

  function removeSong(index) {
    userData.customSetlists[editingLiveId].splice(index, 1);
    renderCurrentSetlist();
    saveUserData();
  }

  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

// 1. é–¢æ•°ã®å¤–ã§ã“ã®å¤‰æ•°ã‚’å®šç¾©ã—ã¦ãã ã•ã„ï¼ˆé‡è¦ï¼ï¼‰
let isStatsFull = false; 


function renderMyStats() {
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  
  // --- 1. æ›²ã®åˆ†æ ---
  const songAnalysis = {};
  Object.entries(userData.customSetlists).forEach(([liveId, songIds]) => {
    const live = masterLives.find(l => String(l.id) === String(liveId));
    if (!live) return;
    songIds.forEach(sid => {
      if (!songAnalysis[sid]) songAnalysis[sid] = { count: 0, lastDate: "", lastLiveName: "", lastVenue: "" };
      songAnalysis[sid].count += 1;
      if (live.date > songAnalysis[sid].lastDate) {
        songAnalysis[sid].lastDate = live.date;
        songAnalysis[sid].lastLiveName = live.title;
        songAnalysis[sid].lastVenue = live.venue;
      }
    });
  });
  const sortedSongs = Object.entries(songAnalysis).sort((a,b) => b[1].count - a[1].count);

  // --- 2. éƒ½é“åºœçœŒã®åˆ†æ ---
  const prefAnalysis = {};
  myLives.forEach(l => {
    const p = l.pref || l.prefecture || l.area;
    if (p) {
      if (!prefAnalysis[p]) prefAnalysis[p] = { count: 0, lastDate: "", lastLiveName: "", lastVenue: "" };
      prefAnalysis[p].count += 1;
      if (l.date > prefAnalysis[p].lastDate) {
        prefAnalysis[p].lastDate = l.date;
        prefAnalysis[p].lastLiveName = l.title;
        prefAnalysis[p].lastVenue = l.venue;
      }
    }
  });
  const sortedPrefs = Object.entries(prefAnalysis).sort((a,b) => b[1] - a[1]);

  const heardSongIds = Object.keys(songAnalysis);
  const unHeardSongs = masterSongs.filter(s => !heardSongIds.includes(String(s.id)));

  // è¡¨ç¤ºåˆ¶é™ã®é©ç”¨
  const displayLimit = isStatsFull ? undefined : 10;
  const songsToShow = sortedSongs.slice(0, displayLimit);
  const prefsToShow = sortedPrefs.slice(0, displayLimit);

  // --- HTMLçµ„ã¿ç«‹ã¦ ---
  let html = `<div class="stats-summary-header">Total Lives: ${myLives.length}</div>`;

  // â‘  è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  html += `
    <div class="stats-card">
      <h5>ğŸµ è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚° ${!isStatsFull ? '(TOP10)' : '(å…¨ä»¶)'}</h5>
      <p style="font-size:0.7em; color:#999; margin: -5px 0 10px 0;">æ›²åã‚¿ãƒƒãƒ—ã§è©³ç´°å±¥æ­´ã‚’è¡¨ç¤º</p>
      <div class="stats-list">
        ${songsToShow.map(([id, data], i) => `
          <div class="stat-row-group">
            <div class="stat-row" onclick="alertSongHistory('${id}')">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${getSongTitle(id)}</span>
              <b class="stat-count">${data.count}å›</b>
            </div>
            <div class="stat-last-date">Last: ${data.lastDate.substring(2).replace(/-/g,'/')} ${data.lastLiveName} @${data.lastVenue}</div>
          </div>
        `).join('') || '<p class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãªã—</p>'}
      </div>
    </div>`;

  // æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ã®ãƒœã‚¿ãƒ³
  if (sortedSongs.length > 10) {
    html += `<button class="btn-more" onclick="toggleStatsFull()">${isStatsFull ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ æ›²ã‚’ã‚‚ã£ã¨è¦‹ã‚‹'}</button>`;
  }

  // â‘¡ æœªé­é‡æ›²ä¸€è¦§
  html += `
    <div class="stats-card">
      <h5 style="color:#666;">ğŸ¤ æœªé­é‡ã®æ›² (${unHeardSongs.length})</h5>
      <div class="unheard-scroll-container">
        <div class="unheard-list">
          ${unHeardSongs.map(s => `<div class="unheard-item">${s.title}</div>`).join('') || '<span>ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼</span>'}
        </div>
      </div>
    </div>`;

  // â‘¢ éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°
  html += `
    <div class="stats-card" style="margin-top:20px;">
      <h5>ğŸ—ºï¸ éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚° ${!isStatsFull ? '(TOP10)' : '(å…¨ä»¶)'}</h5>
      <div class="stats-list">
        ${prefsToShow.map(([pref, data], i) => `
          <div class="stat-row-group">
            <div class="stat-row" onclick="alertPrefHistory('${pref}')">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${pref}</span>
              <b class="stat-count">${data.count}å›</b>
            </div>
            <div class="stat-last-date">Last: ${data.lastDate.substring(2).replace(/-/g,'/')} ${data.lastLiveName} @${data.lastVenue}</div>
          </div>
        `).join('') || '<p class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãªã—</p>'}
      </div>
    </div>`;

  // éƒ½é“åºœçœŒç”¨ã®ãƒœã‚¿ãƒ³
  if (sortedPrefs.length > 10) {
    html += `<button class="btn-more" onclick="toggleStatsFull()">${isStatsFull ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ éƒ½é“åºœçœŒã‚’ã‚‚ã£ã¨è¦‹ã‚‹'}</button>`;
  }

  document.getElementById('my-stats-area').innerHTML = html;
}



// éƒ½é“åºœçœŒã®å±¥æ­´ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
function alertPrefHistory(prefName) {
  const history = masterLives
    .filter(l => userData.attendedIds.includes(l.id) && (l.pref === prefName || l.prefecture === prefName || l.area === prefName))
    .map(l => `${l.date} ${l.title} @${l.venue}`);
  
  if (history.length > 0) {
    alert(`ã€${prefName}ã€‘ã®å‚æˆ¦å±¥æ­´ (${history.length}å›)\n\n${history.sort().reverse().join('\n')}`);
  }
}



function alertSongHistory(songId) {
  const songTitle = getSongTitle(songId);
  const history = [];

  // å…¨ã¦ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã€ãã®æ›²ãŒå«ã¾ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ã‚’æ¢ã™
  Object.entries(userData.customSetlists).forEach(([liveId, songIds]) => {
    // songIdsã®ä¸­èº«ãŒæ•°å€¤ã®å ´åˆã‚‚ã‚ã‚‹ã®ã§ã€Stringã§æ¯”è¼ƒ
    if (songIds.some(sid => String(sid) === String(songId))) {
      const live = masterLives.find(l => String(l.id) === String(liveId));
      if (live) {
        history.push(`${live.date} ${live.title} @${live.venue}`);
      }
    }
  });

  if (history.length > 0) {
    // æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã¦è¡¨ç¤º
    const message = history.sort().reverse().join('\n');
    alert(`ã€${songTitle}ã€‘ã®å‚æˆ¦å±¥æ­´ (${history.length}å›)\n\n${message}`);
  } else {
    alert('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
  }
}




// 2. ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«å‹•ãé–¢æ•°
function toggleStatsFull() {
  isStatsFull = !isStatsFull; // ãƒ•ãƒ©ã‚°ã‚’åè»¢ (true â†” false)
  renderMyStats();            // çµ±è¨ˆç”»é¢ã‚’å†æç”»
}


  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup.json`;
    a.click();
  }

  function importBackup(input) {
    const reader = new FileReader();
    reader.onload = () => { userData = JSON.parse(reader.result); saveUserData(); alert("å¾©å…ƒå®Œäº†"); };
    reader.readAsText(input.files[0]);
  }

  init();
</script>

</body>
</html>
