<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>
  <style>
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« --- */
header {
  background: #222; /* ã‚ˆã‚Šæ·±ã„é»’ã«å¤‰æ›´ */
  color: white;
  padding: 20px 0; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’åºƒã’ã‚‹ */
  text-align: center;
  border-bottom: 4px solid var(--primary); /* ãƒãƒ«ãƒãƒ¬ãƒƒãƒ‰ã®å¤ªã„ä¸‹ç·š */
  box-shadow: 0 4px 15px rgba(230, 0, 18, 0.4); /* èµ¤ã„å…‰å½©ã®ã‚ˆã†ãªå½± */
  position: relative;
  overflow: hidden;
}

/* èƒŒæ™¯ã«ã†ã£ã™ã‚‰ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
header::after {
  content: '';
  position: absolute;
  top: -50%; left: -50%; width: 200%; height: 200%;
  background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(230, 0, 18, 0.05) 10px, rgba(230, 0, 18, 0.05) 20px);
  transform: rotate(15deg);
  z-index: 0;
  pointer-events: none;
}

header h1 {
  font-family: 'RocknRoll One', sans-serif; /* ãƒ­ãƒƒã‚¯ãªãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
  margin: 0;
  font-size: 2.2rem; /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
  letter-spacing: 3px; /* æ–‡å­—é–“éš”ã‚’åºƒã’ã¦å ‚ã€…ã¨ */
  text-transform: uppercase; /* å…¨ã¦å¤§æ–‡å­—ã« */
  position: relative;
  z-index: 1;
  /* èµ¤ã„ç¸å–ã‚Šã¨ç«‹ä½“çš„ãªå½±ã§ãƒ­ã‚´é¢¨ã« */
  text-shadow: 
    2px 2px 0 var(--primary),
    -2px -2px 0 var(--primary),
    2px -2px 0 var(--primary),
    -2px 2px 0 var(--primary),
    4px 4px 0 #000,
    5px 5px 10px rgba(0,0,0,0.5);
}

/* ã‚®ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è£…é£¾ */
.header-icon {
  display: inline-block;
  margin-right: 12px;
  transform: rotate(-15deg) scale(1.2); /* å‚¾ã‘ã¦å°‘ã—å¤§ãã */
  filter: drop-shadow(2px 2px 0 var(--primary)); /* ã‚¢ã‚¤ã‚³ãƒ³ã«ã‚‚èµ¤ã„å½± */
  transition: transform 0.3s ease;
}

/* ãƒ›ãƒãƒ¼æ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ãŒå°‘ã—å‹•ãéŠã³å¿ƒ */
header h1:hover .header-icon {
  transform: rotate(0deg) scale(1.3);
}

    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }
    
    .card { display: block; background: #fff; padding: 16px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .tour-body .card { display: flex !important; justify-content: space-between; align-items: center; padding: 10px 15px; margin-bottom: 0; border-radius: 0; border: none; border-bottom: 1px solid #eee; box-shadow: none; }
    .live-info { flex: 1; font-size: 0.9rem; line-height: 1.4; display: flex; gap: 10px; align-items: center; }
    .btn-mini { border: none; border-radius: 4px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; flex-shrink: 0; font-weight: bold; }

    /* çµ±è¨ˆç”¨è¿½åŠ ãƒ»ä¿®æ­£ã‚¹ã‚¿ã‚¤ãƒ« */
    .stat-ranking-item { background: white; border-bottom: 1px solid #eee; padding: 10px; }
    .stat-ranking-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .stat-rank-num { font-weight: bold; width: 25px; color: var(--primary); font-size: 0.9em; }
    .stat-song-info { flex: 1; min-width: 0; padding-right: 10px; }
    .stat-song-title { font-weight: bold; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* ä¿®æ­£ï¼šç›´è¿‘æƒ…å ±ã‚’1è¡Œã«åã‚ã¦çœç•¥è¡¨ç¤ºã«ã™ã‚‹ */
    .stat-latest-info { font-size: 0.75em; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .stat-count-badge { background: #eee; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; flex-shrink: 0; }
    .stat-details-list { display: none; margin-top: 10px; padding: 10px; border-top: 1px dashed #ddd; background: #fafafa; border-radius: 5px; }
    .stat-details-list.open { display: block; }
    .detail-row { font-size: 0.75em; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 4px; color: #555; line-height: 1.3; }

    /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-show-more, .btn-hide-more { width: 100%; padding: 12px; border: none; margin-top: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 0.85em; }
    .btn-show-more { background: #eee; color: #555; }
    .btn-hide-more { background: #ddd; color: #333; display: none; }
    .hidden-rank-item { display: none; }

    /* ãã®ä»–æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç•¥ï¼‰ */
    .setting-group { display: flex; flex-direction: column; gap: 8px; }
    .btn-setting { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-export { background: #444; color: white; }
    .unheard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; height: 400px; overflow-y: scroll; -webkit-overflow-scrolling: touch; padding: 5px; }
    .unheard-item { background: white; border: 1px solid #eee; border-radius: 4px; font-size: 0.7rem; padding: 2px 4px; min-height: 28px; display: flex; align-items: center; justify-content: center; text-align: center; }
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    .stats-summary-header { background: #333; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; }
    .stats-card { background: white; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .graph-container { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
    .graph-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.8em; }
    .graph-label { width: 40px; text-align: right; margin-right: 8px; color: #555; }
    .graph-bar-area { flex: 1; background: #f0f0f0; height: 16px; border-radius: 4px; overflow: hidden; }
    .graph-bar { height: 100%; background: var(--primary); }
    .graph-val { margin-left: 6px; width: 25px; font-weight: bold; color: #333; }
    .log-actions { display: flex; gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #eee; width: 100%; }
    .btn-log-action { flex: 1; height: 44px; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
    .btn-setlist { background: var(--primary); color: white; }
    .btn-edit-log { background: #444; color: white; }
    .log-title-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .log-date { font-size: 0.8em; color: #888; }
    .log-title { font-weight: bold; color: var(--primary); }
    .setlist-collapse { display: none; background: #fdfdfd; margin-top: 8px; padding: 8px; font-size: 0.85em; border-left: 2px solid #ccc; }
    .setlist-collapse.open { display: block; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary v2.2</h1></header>

<header>
  <h1><span class="header-icon">ğŸ¸</span>PG LIVE DIARY</h1>
</header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list"></div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="stats-total-lives" class="stats-summary-header"></div>

  <h4>ğŸ¤ è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="stats-song-ranking" class="stats-card" style="padding:0; overflow:hidden;"></div>
  <button id="btn-more-songs" class="btn-show-more" onclick="toggleRanking('song', true)">ã‚‚ã£ã¨è¦‹ã‚‹ (11ä½ä»¥ä¸‹)</button>
  <button id="btn-hide-songs" class="btn-hide-more" onclick="toggleRanking('song', false)">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é–‰ã˜ã‚‹</button>

  <h4>ğŸš« ã¾ã è´ã„ã¦ã„ãªã„æ›²</h4>
  <div id="stats-unheard-list" class="stats-card"></div>

  <h4>ğŸ“… å¹´åˆ¥å‚åŠ æ•°</h4>
  <div id="stats-year-graph" class="graph-container"></div>

  <h4>ğŸ“ éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="stats-venue-ranking" class="stats-card" style="padding:0; overflow:hidden;"></div>
  <button id="btn-more-venues" class="btn-show-more" onclick="toggleRanking('venue', true)">ã‚‚ã£ã¨è¦‹ã‚‹ (11ä½ä»¥ä¸‹)</button>
  <button id="btn-hide-venues" class="btn-hide-more" onclick="toggleRanking('venue', false)">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é–‰ã˜ã‚‹</button>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <div class="card">
    <div class="setting-group">
      <div class="setting-label">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
      <button class="btn-setting btn-export" onclick="exportBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
    </div>
    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
    <div class="setting-group">
      <div class="setting-label">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ</div>
      <input type="file" accept=".json" onchange="importBackup(this)" style="width:100%;">
    </div>
  </div>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <h3 id="modal-live-title"></h3>
    <input type="text" id="song-filter" placeholder="æ›²æ¤œç´¢..." oninput="renderMasterSongList()" style="width:100%; padding:10px; margin-bottom:10px;">
    <div id="master-song-select-area" style="max-height:50vh; overflow-y:auto;"></div>
    <div style="margin-top:15px; display:flex; gap:10px;">
      <button onclick="saveCheckedSetlist()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:5px;">ä¿å­˜</button>
      <button onclick="closeModal()" style="padding:12px; background:#ccc; border:none; border-radius:5px;">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<nav>
  <button onclick="showTab('search')" id="nav-search" class="active">ç™»éŒ²</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let currentLiveId = null;
  let tempSelectedSongs = [];

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) {
      console.error(e);
      document.getElementById('master-live-list').innerHTML = "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
    }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
  }

  function renderAll() {
    renderMainLiveList();
    renderMyHistory();
    renderMyStats();
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

  function renderMainLiveList() {
    const container = document.getElementById('master-live-list');
    const grouped = {};
    masterLives.forEach(l => {
      const year = l.date.substring(0, 4);
      if (!grouped[year]) grouped[year] = {};
      if (!grouped[year][l.title]) grouped[year][l.title] = [];
      grouped[year][l.title].push(l);
    });

    let html = "";
    Object.keys(grouped).sort((a,b) => b-a).forEach(year => {
      html += `<div class="year-section"><div class="year-label">${year}</div>`;
      Object.keys(grouped[year]).forEach(title => {
        const lives = grouped[year][title];
        html += `
          <div class="tour-group">
            <div class="tour-header" onclick="this.nextElementSibling.classList.toggle('open')">
              <span>${title}</span>
              <span style="font-size:0.8em; color:#888;">${lives.length}å…¬æ¼” â–¾</span>
            </div>
            <div class="tour-body">
              ${lives.map(l => {
                const isAttended = userData.attendedIds.includes(String(l.id));
                return `
                  <div class="card">
                    <div class="live-info">
                      <span style="color:#888; font-family:monospace;">${l.date.substring(5).replace('-', '/')}</span>
                      <span>${l.venue}</span>
                    </div>
                    <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'}" onclick="toggleAttend('${l.id}', this)">
                      ${isAttended ? 'âœ…' : 'ï¼‹'}
                    </button>
                  </div>`;
              }).join('')}
            </div>
          </div>`;
      });
      html += `</div>`;
    });
    container.innerHTML = html;
  }

  function toggleAttend(id, btn) {
    const idStr = String(id);
    const index = userData.attendedIds.indexOf(idStr);
    let attended = false;
    if (index > -1) {
      if (!confirm("è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      userData.attendedIds.splice(index, 1);
      delete userData.customSetlists[idStr];
    } else {
      userData.attendedIds.push(idStr);
      attended = true;
    }
    saveUserData();
    if (btn) {
      btn.className = `btn-mini ${attended ? 'btn-del' : 'btn-add'}`;
      btn.textContent = attended ? 'âœ…' : 'ï¼‹';
    }
    renderMyHistory();
    renderMyStats();
  }

  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(String(l.id)));
    document.getElementById('stats-total-lives').textContent = `Total Lives: ${myLives.length} å›å‚æˆ¦`;

    if (myLives.length === 0) {
      container.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>å‚æˆ¦å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }

    container.innerHTML = myLives.map(l => {
      const setlist = userData.customSetlists[String(l.id)] || [];
      return `
        <div class="card">
          <div class="log-title-row">
            <span class="log-date">${l.date.replace(/-/g, '/')}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div style="font-size:0.85em; color:#555; margin-bottom:10px;">${l.venue}</div>
          <div class="log-actions">
            <button class="btn-log-action btn-setlist" onclick="document.getElementById('sv-${l.id}').classList.toggle('open')">ğŸ“Š ã‚»ãƒˆãƒª (${setlist.length})</button>
            <button class="btn-log-action btn-edit-log" onclick="openSetlistEditor('${l.id}')">âœï¸ ç·¨é›†</button>
          </div>
          <div id="sv-${l.id}" class="setlist-collapse">
            ${setlist.length > 0 ? setlist.map((sid, i) => `<div>${i+1}. ${getSongTitle(sid)}</div>`).join('') : 'ã‚»ãƒˆãƒªæœªç™»éŒ²'}
          </div>
        </div>`;
    }).join('');
  }

  function renderMyStats() {
    const songCounts = {};
    const prefCounts = {};
    const yearCounts = {};
    const currentYear = new Date().getFullYear();
    for (let y = 1999; y <= currentYear; y++) yearCounts[y] = 0;

    userData.attendedIds.forEach(liveId => {
      const live = masterLives.find(l => String(l.id) === String(liveId));
      if (!live) return;
      const y = live.date.substring(0, 4);
      if (yearCounts[y] !== undefined) yearCounts[y]++;

      const prefName = live.prefecture || live.pref || "ãã®ä»–/ä¸æ˜";
      if (!prefCounts[prefName]) prefCounts[prefName] = { count: 0, lives: [] };
      prefCounts[prefName].count++;
      prefCounts[prefName].lives.push(live);

      const setlist = userData.customSetlists[String(liveId)] || [];
      setlist.forEach(sid => {
        if (!songCounts[sid]) songCounts[sid] = { count: 0, lives: [] };
        songCounts[sid].count++;
        songCounts[sid].lives.push(live);
      });
    });

    // A. æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const sortedSongs = Object.keys(songCounts).map(sid => ({ id: sid, ...songCounts[sid] }))
      .sort((a, b) => b.count - a.count);

    document.getElementById('stats-song-ranking').innerHTML = sortedSongs.map((item, idx) => {
      const song = masterSongs.find(s => String(s.id) === String(item.id));
      item.lives.sort((a,b) => new Date(b.date) - new Date(a.date));
      const latest = item.lives[0];
      const hideClass = idx >= 10 ? 'hidden-rank-item song-hidden' : '';
      return `
        <div class="stat-ranking-item ${hideClass}">
          <div class="stat-ranking-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="stat-rank-num">${idx+1}</div>
            <div class="stat-song-info">
              <div class="stat-song-title">${song ? song.title : 'ä¸æ˜'}</div>
              <div class="stat-latest-info">${latest.date} / ${latest.title} / ${latest.venue}</div>
            </div>
            <div class="stat-count-badge">${item.count}å›</div>
          </div>
          <div class="stat-details-list">
            ${item.lives.map(l => `<div class="detail-row">ğŸ“… ${l.date}<br>ğŸš© ${l.title}<br>ğŸ“ ${l.venue}</div>`).join('')}
          </div>
        </div>`;
    }).join('');

    // B. æœªè´æ›²
    const heardIds = new Set(Object.keys(songCounts).map(String));
    const unheard = masterSongs.filter(s => !heardIds.has(String(s.id)));
    document.getElementById('stats-unheard-list').innerHTML = `
      <div style="font-size:0.85em; margin-bottom:8px; font-weight:bold;">æœªè´æ›² (${unheard.length})</div>
      <div class="unheard-grid">${unheard.map(s => `<div class="unheard-item">${s.title}</div>`).join('')}</div>`;

    // C. å¹´åˆ¥
    const maxVal = Math.max(...Object.values(yearCounts), 1);
    document.getElementById('stats-year-graph').innerHTML = Object.keys(yearCounts).map(year => {
      const val = yearCounts[year];
      if (val === 0 && year < 1999) return '';
      return `<div class="graph-row">
        <div class="graph-label">${year}</div>
        <div class="graph-bar-area"><div class="graph-bar" style="width:${(val/maxVal)*100}%"></div></div>
        <div class="graph-val">${val}</div>
      </div>`;
    }).join('');

    // D. éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const sortedPrefs = Object.keys(prefCounts).map(p => ({ name: p, ...prefCounts[p] }))
      .sort((a,b) => b.count - a.count);

    document.getElementById('stats-venue-ranking').innerHTML = sortedPrefs.map((item, idx) => {
      const hideClass = idx >= 10 ? 'hidden-rank-item venue-hidden' : '';
      return `
        <div class="stat-ranking-item ${hideClass}">
          <div class="stat-ranking-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="stat-rank-num">${idx+1}</div>
            <div class="stat-song-info"><div class="stat-song-title">${item.name}</div></div>
            <div class="stat-count-badge">${item.count}å›</div>
          </div>
          <div class="stat-details-list">
            ${item.lives.map(l => `<div class="detail-row">ğŸ“… ${l.date}<br>ğŸš© ${l.title}<br>ğŸ“ ${l.venue}</div>`).join('')}
          </div>
        </div>`;
    }).join('');
    
    // ãƒœã‚¿ãƒ³ã®åˆæœŸè¡¨ç¤ºçŠ¶æ…‹
    toggleRanking('song', false);
    toggleRanking('venue', false);
    document.getElementById('btn-more-songs').style.display = sortedSongs.length > 10 ? 'block' : 'none';
    document.getElementById('btn-more-venues').style.display = sortedPrefs.length > 10 ? 'block' : 'none';
  }

  // ã‚‚ã£ã¨è¦‹ã‚‹ãƒ»é–‰ã˜ã‚‹ã®åˆ‡ã‚Šæ›¿ãˆ
  function toggleRanking(type, show) {
    const selector = type === 'song' ? '.song-hidden' : '.venue-hidden';
    const btnMore = document.getElementById(type === 'song' ? 'btn-more-songs' : 'btn-more-venues');
    const btnHide = document.getElementById(type === 'song' ? 'btn-hide-songs' : 'btn-hide-venues');

    document.querySelectorAll(selector).forEach(el => {
      el.style.display = show ? 'block' : 'none';
    });

    if (show) {
      btnMore.style.display = 'none';
      btnHide.style.display = 'block';
    } else {
      // 10ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ã‚’å‡ºã™
      const items = document.querySelectorAll(selector).length;
      if (items > 0) btnMore.style.display = 'block';
      btnHide.style.display = 'none';
    }
  }

  function getSongTitle(id) {
    const s = masterSongs.find(m => String(m.id) === String(id));
    return s ? s.title : "ä¸æ˜";
  }

  function openSetlistEditor(liveId) {
    currentLiveId = String(liveId);
    const live = masterLives.find(l => String(l.id) === currentLiveId);
    tempSelectedSongs = userData.customSetlists[currentLiveId] ? [...userData.customSetlists[currentLiveId]] : [];
    document.getElementById('modal-live-title').textContent = live ? live.title : "ç·¨é›†";
    document.getElementById('edit-modal').style.display = 'block';
    renderMasterSongList();
  }

  function renderMasterSongList() {
    const area = document.getElementById('master-song-select-area');
    const query = document.getElementById('song-filter').value.toLowerCase();
    const filtered = masterSongs.filter(s => (s.title||"").toLowerCase().includes(query) || (s.ruby||"").toLowerCase().includes(query))
      .sort((a,b) => (a.ruby||a.title).localeCompare(b.ruby||b.title, 'ja'));

    area.innerHTML = filtered.map(s => {
      const id = String(s.id);
      const idx = tempSelectedSongs.indexOf(id);
      return `<div class="card" style="display:flex; justify-content:space-between; padding:10px; margin-bottom:5px; background:${idx>-1?'#fff0f0':'#fff'}" onclick="toggleSongSelection('${id}')">
        <span>${s.title}</span>
        <span>${idx > -1 ? `<b>[${idx+1}]</b>` : 'â—‹'}</span>
      </div>`;
    }).join('');
  }

  function toggleSongSelection(id) {
    const idx = tempSelectedSongs.indexOf(id);
    if (idx > -1) tempSelectedSongs.splice(idx, 1);
    else tempSelectedSongs.push(id);
    renderMasterSongList();
  }

  function saveCheckedSetlist() {
    userData.customSetlists[currentLiveId] = [...tempSelectedSongs];
    saveUserData();
    renderAll();
    closeModal();
  }

  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `pg_backup.json`;
    a.click();
  }

  function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        userData = JSON.parse(e.target.result);
        saveUserData();
        renderAll();
        alert("å¾©å…ƒå®Œäº†");
      } catch (err) { alert("å¤±æ•—"); }
    };
    reader.readAsText(file);
  }

  init();
</script>
</body>
</html>
