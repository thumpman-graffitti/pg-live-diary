<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>
  <style>
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ç¶™æ‰¿ */
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    .my-log-card { display: block !important; padding: 10px 12px !important; margin-bottom: 8px !important; background: white; border-radius: 6px; border: 1px solid #ddd; }
    .log-title-row { display: flex; align-items: baseline; gap: 8px; }
    .log-date { font-size: 0.8em; color: #888; }
    .log-title { font-weight: bold; color: var(--primary); }
    .log-actions { display: flex; gap: 5px; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 8px; }
    .setlist-collapse { display: none; background: #fdfdfd; margin-top: 8px; padding: 8px; font-size: 0.85em; border-left: 2px solid #ccc; }
    .setlist-collapse.open { display: block; }
    .stats-summary-header { background: #333; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; }
    .stats-card { background: white; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .stat-row { display: flex; align-items: center; font-size: 0.85em; padding: 4px 0; }
    .stat-name { flex: 1; color: var(--primary); text-decoration: underline; }
    .unheard-scroll-container { max-height: 150px; overflow-y: auto; background: #fafafa; padding: 8px; }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ç”¨è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .editor-header-sticky { position: sticky; top: -20px; background: white; z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #eee; }
    .setlist-scroll-area { max-height: 50vh; overflow-y: auto; margin-top: 10px; }
    .song-select-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; }
    .song-select-item.selected { background: #fff0f0; }
    .song-index-label { width: 30px; font-size: 0.8em; color: var(--primary); font-weight: bold; }
    .song-title-text { flex: 1; font-size: 0.9em; }
    .song-number-badge { background: var(--primary); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; }
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary2</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list"></div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn-edit" onclick="exportBackup()" style="background:#666;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <div class="editor-header-sticky">
      <h3 id="modal-live-title" style="margin:0 0 10px 0; font-size:1.1em;"></h3>
      <input type="text" id="song-filter" placeholder="æ›²åãƒ»ãƒ«ãƒ“ã§æ¤œç´¢..." oninput="renderMasterSongList()">
    </div>
    
    <div id="master-song-select-area" class="setlist-scroll-area">
      </div>

    <div style="margin-top:15px; display:flex; gap:10px;">
      <button onclick="saveCheckedSetlist()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
      <button onclick="closeModal()" style="padding:12px; background:#ccc; border:none; border-radius:5px;">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let currentLiveId = null;
  let tempSelectedSongs = [];

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) {
      console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      document.getElementById('master-live-list').innerHTML = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
  }

  function renderAll() {
    renderMainLiveList();
    renderMyHistory();
    renderMyStats();
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

  // --- æ¢ã™ã‚¿ãƒ– ---
  function renderMainLiveList() {
    const container = document.getElementById('master-live-list');
    const grouped = {};
    masterLives.forEach(l => {
      const year = l.date.substring(0, 4);
      if (!grouped[year]) grouped[year] = {};
      if (!grouped[year][l.title]) grouped[year][l.title] = [];
      grouped[year][l.title].push(l);
    });

    let html = "";
    Object.keys(grouped).sort((a,b) => b-a).forEach(year => {
      html += `<div class="year-section"><div class="year-label">${year}</div>`;
      Object.keys(grouped[year]).forEach(tourTitle => {
        const livesInTour = grouped[year][tourTitle];
        html += `
          <div class="tour-group">
            <div class="tour-header" onclick="toggleTour(event, this)">
              <span>${tourTitle}</span>
              <span style="font-size:0.8em; color:#888;">${livesInTour.length}å…¬æ¼” â–¾</span>
            </div>
            <div class="tour-body">
              ${livesInTour.map(l => {
                const isAttended = userData.attendedIds.includes(String(l.id));
                return `
                  <div class="card">
                    <div class="live-info">
                      <span class="live-date">${l.date.substring(5)}</span>
                      <span>${l.venue}</span>
                    </div>
                    <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'}" onclick="toggleAttend('${l.id}')">
                      ${isAttended ? 'âœ…' : 'ï¼‹'}
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>`;
      });
      html += `</div>`;
    });
    container.innerHTML = html;
  }

  function toggleTour(e, header) {
    header.nextElementSibling.classList.toggle('open');
  }

  function toggleAttend(id) {
    const idStr = String(id);
    const index = userData.attendedIds.indexOf(idStr);
    if (index > -1) {
      if (confirm("å‚æˆ¦ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚»ãƒˆãƒªã‚‚æ¶ˆå»ã•ã‚Œã¾ã™ï¼‰")) {
        userData.attendedIds.splice(index, 1);
        delete userData.customSetlists[idStr];
      }
    } else {
      userData.attendedIds.push(idStr);
    }
    saveUserData();
    renderAll();
  }

  // --- å±¥æ­´ã‚¿ãƒ– ---
  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(String(l.id)));
    
    let html = `<div class="stats-summary-header">Total Lives: ${myLives.length}</div>`;
    if (myLives.length === 0) {
      container.innerHTML = html + "<p style='text-align:center; color:#888; padding:20px;'>å‚æˆ¦å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }

    html += myLives.map(l => {
      const setlist = userData.customSetlists[String(l.id)] || [];
      return `
        <div class="card my-log-card">
          <div class="log-title-row">
            <span class="log-date">${l.date}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div style="font-size:0.85em;">${l.venue}</div>
          <div class="log-actions">
            <button class="btn-mini" onclick="document.getElementById('sv-${l.id}').classList.toggle('open')">ğŸ“Š ã‚»ãƒˆãƒª (${setlist.length})</button>
            <button class="btn-mini" style="background:#666; color:white;" onclick="openSetlistEditor('${l.id}')">âœï¸ ç·¨é›†</button>
          </div>
          <div id="sv-${l.id}" class="setlist-collapse">
            ${setlist.length > 0 ? setlist.map((sid, i) => `<div>${i+1}. ${getSongTitle(sid)}</div>`).join('') : 'æœªç™»éŒ²'}
          </div>
        </div>`;
    }).join('');
    container.innerHTML = html;
  }

  function getSongTitle(id) {
    const s = masterSongs.find(m => String(m.id) === String(id));
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  // --- çµ±è¨ˆã‚¿ãƒ– ---
  function renderMyStats() {
    const area = document.getElementById('my-stats-area');
    const counts = {};
    let totalSongsHeard = 0;

    // é›†è¨ˆ
    Object.values(userData.customSetlists).forEach(list => {
      list.forEach(sid => {
        counts[sid] = (counts[sid] || 0) + 1;
        totalSongsHeard++;
      });
    });

    const sortedIds = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
    const heardSongIds = new Set(Object.keys(counts).map(String));
    const unheardSongs = masterSongs.filter(s => !heardSongIds.has(String(s.id)));

    let html = `
      <div class="stats-summary-header">
        <div style="font-size:1.2em;">è´ã„ãŸæ›²æ•°: ${heardSongIds.size} / ${masterSongs.length}</div>
        <div style="font-size:0.8em; opacity:0.8;">å»¶ã¹æ¼”å¥å›æ•°: ${totalSongsHeard}å›</div>
      </div>
      
      <h4>ğŸ¤ æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
      <div class="stats-card">
        ${sortedIds.length > 0 ? sortedIds.slice(0, 20).map(sid => `
          <div class="stat-row">
            <span class="stat-name">${getSongTitle(sid)}</span>
            <span class="stat-count"><b>${counts[sid]}</b> å›</span>
          </div>
        `).join('') : '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
      </div>

      <h4>ğŸš« æœªè´ã®æ›² (${unheardSongs.length})</h4>
      <div class="stats-card unheard-scroll-container">
        ${unheardSongs.map(s => `<div style="font-size:0.85em; padding:2px 0;">ãƒ»${s.title}</div>`).join('')}
      </div>
    `;
    area.innerHTML = html;
  }

  // --- ã‚»ãƒˆãƒªã‚¨ãƒ‡ã‚£ã‚¿ ---
  function openSetlistEditor(liveId) {
    currentLiveId = String(liveId);
    const live = masterLives.find(l => String(l.id) === currentLiveId);
    tempSelectedSongs = userData.customSetlists[currentLiveId] ? [...userData.customSetlists[currentLiveId]] : [];
    
    document.getElementById('modal-live-title').textContent = live ? live.title : "ã‚»ãƒˆãƒªç·¨é›†";
    document.getElementById('song-filter').value = "";
    document.getElementById('edit-modal').style.display = 'block';
    renderMasterSongList();
  }

  function renderMasterSongList() {
    const area = document.getElementById('master-song-select-area');
    const query = document.getElementById('song-filter').value.toLowerCase();
    
    let filtered = masterSongs.filter(s => 
      (s.title || "").toLowerCase().includes(query) || (s.ruby || "").toLowerCase().includes(query)
    );

    filtered.sort((a,b) => (a.ruby || a.title).localeCompare(b.ruby || b.title, 'ja'));

    let lastChar = "";
    area.innerHTML = filtered.map(s => {
      const idStr = String(s.id);
      const selIdx = tempSelectedSongs.indexOf(idStr);
      let indexDisplay = "";
      const curChar = (s.ruby || s.title || "#").charAt(0).toUpperCase();
      if (curChar !== lastChar) {
        indexDisplay = curChar;
        lastChar = curChar;
      }

      return `
        <div class="song-select-item ${selIdx > -1 ? 'selected' : ''}" onclick="toggleSongSelection('${idStr}')">
          <div class="song-index-label">${indexDisplay}</div>
          <div class="song-title-text">${s.title}</div>
          <div>${selIdx > -1 ? `<div class="song-number-badge">${selIdx+1}</div>` : 'â—‹'}</div>
        </div>`;
    }).join('');
  }

  function toggleSongSelection(id) {
    const idx = tempSelectedSongs.indexOf(id);
    if (idx > -1) tempSelectedSongs.splice(idx, 1);
    else tempSelectedSongs.push(id);
    renderMasterSongList();
  }

  function saveCheckedSetlist() {
    userData.customSetlists[currentLiveId] = [...tempSelectedSongs];
    saveUserData();
    renderAll();
    closeModal();
  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  // --- è¨­å®šï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ ---
  function exportBackup() {
    const dataStr = JSON.stringify(userData);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pg_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  }

  function importBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const imported = JSON.parse(event.target.result);
          if (imported.attendedIds) {
            userData = imported;
            saveUserData();
            renderAll();
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼");
          }
        } catch (err) {
          alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  init();
</script>




</body>
</html>
