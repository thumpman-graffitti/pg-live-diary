<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>

  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* å¹´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }

    /* ãƒ„ã‚¢ãƒ¼åˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }

    /* ãƒ©ã‚¤ãƒ–é …ç›®ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .card:last-child { border-bottom: none; }
    .live-info { font-size: 0.9em; }
    .live-date { color: #888; font-size: 0.8em; margin-right: 5px; }

    /* å°ã•ã„ãƒœã‚¿ãƒ³ */
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    
    /* iPhoneã‚ºãƒ¼ãƒ å¯¾ç­– */
    #song-search { font-size: 16px !important; width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
    .song-item { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #eee; align-items: center; }

    /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    .my-log-card { display: block !important; padding: 10px 12px !important; margin-bottom: 8px !important; background: white; border-radius: 6px; border: 1px solid #ddd; }
    .log-title-row { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; }
    .log-date { font-size: 0.8em; color: #888; font-family: monospace; }
    .log-title { font-weight: bold; font-size: 1em; color: var(--primary); flex: 1; }
    .log-venue { font-size: 0.85em; color: #333; margin-bottom: 8px; }
    .log-actions { display: flex; gap: 5px; border-top: 1px dashed #eee; padding-top: 8px; }
    .btn-view-setlist { background: #f0f0f0; color: #333; flex: 2; }
    .btn-edit-icon { background: #666; color: white; flex: 1; }
    .setlist-collapse { display: none; background: #fdfdfd; margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 0.85em; color: #555; border-left: 2px solid #ccc; line-height: 1.5; }
    .setlist-collapse.open { display: block; }        

    /* --- çµ±è¨ˆãƒšãƒ¼ã‚¸ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    .stats-summary-header { background: #333; color: white; text-align: center; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1.1em; margin-bottom: 15px; }
    
    .stats-card { background: white; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .stats-card h5 { margin: 0 0 8px 0; color: var(--primary); border-bottom: 2px solid #f4f4f4; padding-bottom: 4px; font-size: 0.9em; }

    .stat-row-group { border-bottom: 1px solid #f2f2f2; padding: 4px 0; }
    .stat-row { display: flex; align-items: center; padding: 0; font-size: 0.85em; cursor: pointer; }
    .stat-rank { width: 25px; font-size: 0.75em; color: #aaa; font-weight: bold; }
    .stat-name { flex: 1; color: var(--primary); text-decoration: underline; font-weight: bold; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stat-count { min-width: 35px; text-align: right; color: var(--primary); font-size: 0.9em; font-weight: bold; }

    .stat-last-date { font-size: 0.65em; color: #888; margin-left: 25px; margin-top: -1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-bottom: 2px; }

    /* ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ */
    .btn-more { width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; color: #666; font-weight: bold; cursor: pointer; margin: 5px 0 15px 0; font-size: 0.85em; }

    /* æœªé­é‡æ›²ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ  */
    .unheard-scroll-container { max-height: 150px; overflow-y: auto; background: #fafafa; border-radius: 6px; border: 1px solid #eee; padding: 8px; }
    .unheard-list { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; }
    .unheard-item { font-size: 0.72em; color: #888; padding: 3px 0; border-bottom: 1px solid #f0f0f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .unheard-item::before { content: "â€¢ "; color: #ccc; }

  
.yearly-chart-container { display: flex; flex-direction: column; gap: 4px; margin-top: 5px; }
.chart-row { display: flex; align-items: center; gap: 8px; height: 18px; }
.chart-year { font-size: 0.7em; font-family: monospace; color: #666; width: 35px; }
.chart-bar-area { flex: 1; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden; }
.chart-bar { background: var(--primary); height: 100%; border-radius: 4px; }
.chart-count { font-size: 0.7em; font-weight: bold; color: var(--primary); width: 30px; text-align: right; }

/* ãƒã‚§ãƒƒã‚¯å½¢å¼ã‚¨ãƒ‡ã‚£ã‚¿å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.song-select-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 10px; /* å°‘ã—åºƒã‚ã«ã—ã¦æŠ¼ã—ã‚„ã™ã */
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}

/* é¸æŠã•ã‚ŒãŸæ›²ã®èƒŒæ™¯ã‚’è–„ã„èµ¤ã« */
.song-select-item.selected {
  background: #fff0f0;
}

/* æ›²åã®æ¨ªã«å‡ºã‚‹ç•ªå·ãƒãƒƒã‚¸ */
.song-number-badge {
  background: var(--primary);
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8em;
  font-weight: bold;
}

/* ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
.editor-footer {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  background: white;
  padding-top: 10px;
  border-top: 1px solid #eee;
}

/* è¿½åŠ ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å›ºå®šã™ã‚‹ãŸã‚ã®è¨­å®š */
.editor-header-sticky {
  position: sticky;
  top: -20px;
  background: white;
  z-index: 100;
  padding: 10px 0;
  border-bottom: 2px solid #eee;
}

/* è¿½åŠ ï¼šæ›²ãƒªã‚¹ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
.setlist-scroll-area {
  max-height: 60vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ä¿®æ­£ï¼šiPhoneã§ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ã®ãŸã‚ input ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ 16px ä»¥ä¸Šã«å¼·åˆ¶ */
#song-filter {
  font-size: 16px !important;
  width: 100%;
  padding: 12px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 5px;
}

/* ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
.song-select-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px; /* ã•ã‚‰ã«å°‘ã—è©°ã‚ã¾ã—ãŸ */
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

/* å·¦å´ã®ã€Œã‚ã€ã€Œã„ã€ãªã©ã®ãƒ©ãƒ™ãƒ« */
.song-index-label {
  width: 25px;
  font-size: 0.75em;
  color: var(--primary);
  font-weight: bold;
  flex-shrink: 0;
}

.song-title-text {
  flex: 1;
  font-size: 0.9em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 5px;
}






  </style>


</head>
<body>

<header><h1>ğŸ¸ PG Live Diary3</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn-edit" onclick="exportBackup()" style="background:#666;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
  <div style="margin-top:20px;">
    <label style="font-size: 0.9em; color: #666;">ãƒªã‚¹ãƒˆã‚¢ï¼š</label>
    <input type="file" onchange="importBackup(this)">
  </div>
</div>

<div id="edit-modal">
   <div class="modal-content" id="modal-container">
  
    <h3 id="modal-title"></h3>
    <div id="current-setlist"></div>
    <hr>
    <h4>æ›²ã‚’è¿½åŠ </h4>
    <input type="text" id="song-search" placeholder="æ›²åã‚’æ¤œç´¢..." oninput="searchSongs(this.value)">
    <div id="search-results" style="max-height: 250px; overflow-y: auto;"></div>
    <button class="btn-mini" onclick="closeModal()" style="background:#333; color:white; width:100%; padding:10px; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let editingLiveId = null;

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) { console.error(e); }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }


function renderMasterSongList() {
  const area = document.getElementById('master-song-select-area');
  const filterInput = document.getElementById('song-filter');
  const query = filterInput ? filterInput.value.toLowerCase() : "";
  
  if (!area) return;

  // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filteredSongs = masterSongs.filter(s => {
    const title = (s.title || "").toLowerCase();
    const ruby = (s.ruby || "").toLowerCase();
    return title.includes(query) || ruby.includes(query);
  });

  // 2. 50éŸ³é †ã‚½ãƒ¼ãƒˆ
  filteredSongs.sort((a, b) => {
    const valA = a.ruby || a.title || "zzzz"; // ãƒ«ãƒ“ã‚‚ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ãªã„å ´åˆã¯æœ€å¾Œã«
    const valB = b.ruby || b.title || "zzzz";
    return valA.localeCompare(valB, 'ja');
  });

  let lastIndexChar = ""; 

  // 3. æç”»
  area.innerHTML = filteredSongs.map(s => {
    const songIdStr = String(s.id);
    const selectedIndex = tempSelectedSongs.indexOf(songIdStr);
    const isSelected = selectedIndex > -1;
    
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ–‡å­—ã®åˆ¤å®šï¼ˆã“ã“ã‚’å¾¹åº•çš„ã«å®‰å…¨ã«ã—ã¾ã—ãŸï¼‰
    let currentIndexChar = "";
    const baseChar = (s.ruby || s.title || "").charAt(0);
    
    if (!baseChar) {
      currentIndexChar = "ï¼Ÿ";
    } else if (/[ã-ã‚“ã‚¡-ãƒ¶]/.test(baseChar)) {
      currentIndexChar = baseChar; 
    } else if (/[a-zA-Z]/.test(baseChar)) {
      currentIndexChar = baseChar.toUpperCase(); 
    } else {
      currentIndexChar = "è¨˜"; 
    }

    // é‡è¤‡è¡¨ç¤ºã‚’é˜²ã
    let displayIndex = "";
    if (currentIndexChar !== lastIndexChar) {
      displayIndex = currentIndexChar;
      lastIndexChar = currentIndexChar;
    }
    
    return `
      <div class="song-select-item ${isSelected ? 'selected' : ''}" onclick="toggleSongSelection('${songIdStr}')">
        <div class="song-index-label">${displayIndex}</div>
        <div class="song-title-text">${s.title || "ç„¡é¡Œ"}</div>
        <div class="check-area">
          ${isSelected ? `<div class="song-number-badge">${selectedIndex + 1}</div>` : '<span style="color:#ddd; font-size:1em;">â—‹</span>'}
        </div>
      </div>
    `;
  }).join('');
}




function toggleTour(event, header) {
  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯çµ¶å¯¾ã«å‹•ã‹ã•ãªã„
  if (event.target.closest('button')) return;
  
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}




// ãƒœã‚¿ãƒ³ã«ç›´æ¥ã€Œã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç„¡è¦–ã™ã‚‹ã€è¨­å®šã‚’æµã—è¾¼ã‚€
function attachButtonEvents() {
  const btns = document.querySelectorAll('.js-attend-btn');
  btns.forEach(btn => {
    btn.onclick = function(e) {
      // 1. è¦ªã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼é”ã‚’å¾¹åº•çš„ã«æ‹’å¦
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const liveId = this.getAttribute('data-id');
      toggleAttend(liveId);
      
      // 2. ã“ã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ false ã«ã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®é€£é–ã‚’æ­¢ã‚ã‚‹
      return false;
    };
  });
}

// ã“ã¡ã‚‰ã®é–¢æ•°ã‚‚ã“ã‚Œã ã‘ã«ç°¡ç•¥åŒ–
function handleToggleAttend(event, id) {
  // HTMLå´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã“ã¨ã¯ãªããªã‚Šã¾ã™ãŒã€å®šç¾©ã ã‘æ®‹ã—ã¦ãŠãã¾ã™
  if (event) event.stopPropagation();
  toggleAttend(id);
}

function toggleAttend(id) {
  // 1. ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
  const index = userData.attendedIds.indexOf(id);
  if (index > -1) {
    const live = masterLives.find(l => l.id == id);
    const hasSetlist = userData.customSetlists[id] && userData.customSetlists[id].length > 0;
    let message = `ã€Œ${live.venue}ã€ã®å‚æˆ¦ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    if (hasSetlist) message += "\nâ€»ç™»éŒ²æ¸ˆã¿ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
    
    if (!confirm(message)) return;

    userData.attendedIds.splice(index, 1);
    delete userData.customSetlists[id];
  } else {
    userData.attendedIds.push(id);
  }

  // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆrenderAllã¯å‘¼ã°ãªã„ï¼‰
  localStorage.setItem('pg_user_diary', JSON.stringify(userData));

  // 3. ã€é‡è¦ã€‘ç”»é¢å…¨ä½“ã‚’å†æç”»ã›ãšã€æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã ã‘ã‚’æ›¸ãæ›ãˆã‚‹
  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn) {
    const isAttended = userData.attendedIds.includes(id);
    btn.className = `btn-mini ${isAttended ? 'btn-del' : 'btn-add'} js-attend-btn`;
    btn.innerHTML = isAttended ? 'âœ…' : 'ï¼‹';
  }
  
  // 4. ä»–ã®ã‚¿ãƒ–ï¼ˆå±¥æ­´ã‚„çµ±è¨ˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚è£ã§æ›´æ–°ã—ã¦ãŠã
  renderMyHistory();
  renderMyStats();
}

// å±¥æ­´ãƒšãƒ¼ã‚¸ã®æ›´æ–°
function renderMyHistory() {
  const container = document.getElementById('my-history-list');
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  
  // 1ç•ªä¸Šã«å‚æˆ¦å›æ•°ã‚’è¡¨ç¤º
  let html = `<div class="stats-summary-header">Total Lives: ${myLives.length}</div>`;

  if (myLives.length === 0) {
    container.innerHTML = html + "ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  html += myLives.map(l => {
    const setlist = userData.customSetlists[l.id] || [];
    return `
      <div class="card my-log-card">
        <div class="log-main-info">
          <div class="log-title-row">
            <span class="log-date">${l.date.substring(2).replace(/-/g, '/')}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div class="log-venue">${l.venue}</div>
        </div>
        <div class="log-actions">
          <button class="btn-mini btn-view-setlist" onclick="toggleSetlistDisplay('${l.id}')">
            ğŸ“Š ã‚»ãƒˆãƒª ${setlist.length > 0 ? `(${setlist.length})` : ''}
          </button>
          <button class="btn-mini btn-edit-icon" onclick="openSetlistEditor('${l.id}')">âœï¸ ç·¨é›†</button>
        </div>
        <div id="setlist-view-${l.id}" class="setlist-collapse">
          <div class="setlist-content">
            ${setlist.length > 0 
              ? setlist.map((s, i) => `<div>${i+1}. ${getSongTitle(s)}</div>`).join('')
              : '<span style="color:#999;">ã‚»ãƒˆãƒªæœªç™»éŒ²</span>'}
          </div>
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = html;
}



// ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°ï¼ˆæ–°è¨­ï¼‰
function toggleSetlistDisplay(id) {
  const el = document.getElementById(`setlist-view-${id}`);
  el.classList.toggle('open');
}

 

  function getSongTitle(songId) {
    const s = masterSongs.find(sm => sm.id == songId);
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }



let tempSelectedSongs = []; // ç·¨é›†ä¸­ã®é¸æŠé †ã‚’ä¸€æ™‚ä¿å­˜

function openSetlistEditor(liveId) {
    currentLiveId = liveId;
    const live = lives.find(l => l.id === liveId);
    // tempSelectedSongsã‚’ã‚»ãƒƒãƒˆã€‚ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ãªã„IDãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
    tempSelectedSongs = live ? [...live.setlist.map(String)] : [];
    
    document.getElementById('modal-live-title').textContent = live ? live.title : "æ–°è¦ã‚»ãƒˆãƒª";
    document.getElementById('setlist-modal').style.display = 'flex';
    
    renderMasterSongList(); // ã“ã“ã§ãƒªã‚¹ãƒˆã‚’æç”»
}




// 2. æ›²ãƒªã‚¹ãƒˆã‚’æç”»ï¼ˆçµã‚Šè¾¼ã¿å¯¾å¿œï¼‰
function renderMasterSongList() {
  const area = document.getElementById('master-song-select-area');
  const query = document.getElementById('song-filter').value.toLowerCase();
  
  area.innerHTML = masterSongs
    .filter(s => s.title.toLowerCase().includes(query) || (s.ruby && s.ruby.includes(query)))
    .map(s => {
      const songIdStr = String(s.id);
      const selectedIndex = tempSelectedSongs.indexOf(songIdStr);
      const isSelected = selectedIndex > -1;
      
      return `
        <div class="song-select-item ${isSelected ? 'selected' : ''}" onclick="toggleSongSelection('${songIdStr}')">
          <span style="font-size:0.95em; flex:1;">${s.title}</span>
          <div class="check-area">
            ${isSelected ? `<div class="song-number-badge">${selectedIndex + 1}</div>` : '<span style="color:#ccc; font-size:1.2em;">â—‹</span>'}
          </div>
        </div>
      `;
    }).join('');
}

// 3. æ›²ã®é¸æŠ/è§£é™¤
function toggleSongSelection(songId) {
  const index = tempSelectedSongs.indexOf(songId);
  if (index > -1) {
    // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚Œã°è§£é™¤
    tempSelectedSongs.splice(index, 1);
  } else {
    // æœªé¸æŠãªã‚‰æœ€å¾Œå°¾ã«è¿½åŠ 
    tempSelectedSongs.push(songId);
  }
  // ãƒªã‚¹ãƒˆéƒ¨åˆ†ã ã‘å†æç”»ï¼ˆé«˜é€Ÿï¼‰
  renderMasterSongList();
}

// 4. ä¿å­˜ã—ã¦é–‰ã˜ã‚‹
function saveCheckedSetlist(liveId) {
  userData.customSetlists[liveId] = [...tempSelectedSongs];
  saveUserData(); // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
  renderMyHistory(); // å±¥æ­´ã‚¿ãƒ–ã®è¡¨ç¤ºæ›´æ–°
  renderMyStats();   // çµ±è¨ˆã®æ›´æ–°
  closeModal();
}

function closeModal() {
  document.getElementById('edit-modal').style.display = 'none';
}

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

// 1. é–¢æ•°ã®å¤–ã§ã“ã®å¤‰æ•°ã‚’å®šç¾©ã—ã¦ãã ã•ã„ï¼ˆé‡è¦ï¼ï¼‰
let isSongStatsFull = false; // æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨
let isPrefStatsFull = false; // éƒ½é“åºœçœŒç”¨

function toggleSongStats() {
  isSongStatsFull = !isSongStatsFull;
  renderMyStats();
}

function togglePrefStats() {
  isPrefStatsFull = !isPrefStatsFull;
  renderMyStats();
}

function renderMyStats() {
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  const currentYear = new Date().getFullYear();
  
  // --- 1. æ›²ã®åˆ†æ ---
  const songAnalysis = {};
  Object.entries(userData.customSetlists).forEach(([liveId, songIds]) => {
    const live = masterLives.find(l => String(l.id) === String(liveId));
    if (!live) return;
    songIds.forEach(sid => {
      if (!songAnalysis[sid]) songAnalysis[sid] = { count: 0, lastDate: "", lastLiveName: "", lastVenue: "" };
      songAnalysis[sid].count += 1;
      if (live.date > songAnalysis[sid].lastDate) {
        songAnalysis[sid].lastDate = live.date;
        songAnalysis[sid].lastLiveName = live.title;
        songAnalysis[sid].lastVenue = live.venue;
      }
    });
  });
  const sortedSongs = Object.entries(songAnalysis).sort((a,b) => b[1].count - a[1].count);

  // --- 2. éƒ½é“åºœçœŒ & å¹´åˆ¥ã‚°ãƒ©ãƒ•ã®åˆ†æ ---
  const prefAnalysis = {};
  const yearlyCounts = {};
  for (let y = 1999; y <= currentYear; y++) { yearlyCounts[y] = 0; }

  myLives.forEach(l => {
    // éƒ½é“åºœçœŒé›†è¨ˆ
    const p = l.pref || l.prefecture || l.area;
    if (p) {
      if (!prefAnalysis[p]) prefAnalysis[p] = { count: 0, lastDate: "", lastLiveName: "", lastVenue: "" };
      prefAnalysis[p].count += 1;
      if (l.date > prefAnalysis[p].lastDate) {
        prefAnalysis[p].lastDate = l.date;
        prefAnalysis[p].lastLiveName = l.title;
        prefAnalysis[p].lastVenue = l.venue;
      }
    }
    // å¹´åˆ¥é›†è¨ˆ
    const year = l.date.substring(0, 4);
    if (yearlyCounts[year] !== undefined) yearlyCounts[year]++;
  });

  const sortedPrefs = Object.entries(prefAnalysis).sort((a,b) => b[1].count - a[1].count);
  const maxYearlyCount = Math.max(...Object.values(yearlyCounts), 1);

  // åˆ¶è¦‡ç‡ã®è¨ˆç®—
  const visitedCount = Object.keys(prefAnalysis).length;
  const conquestRate = Math.floor((visitedCount / 47) * 100);

  const heardSongIds = Object.keys(songAnalysis);
  const unHeardSongs = masterSongs.filter(s => !heardSongIds.includes(String(s.id)));

  const songLimit = isSongStatsFull ? undefined : 10;
  const prefLimit = isPrefStatsFull ? undefined : 10;
  const songsToShow = sortedSongs.slice(0, songLimit);
  const prefsToShow = sortedPrefs.slice(0, prefLimit);

  // --- HTMLçµ„ã¿ç«‹ã¦ ---
  let html = `<div class="stats-summary-header">Total Lives: ${myLives.length}</div>`;

  // â‘  è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  html += `
    <div class="stats-card">
      <h5>ğŸµ è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚° ${!isSongStatsFull ? '(TOP10)' : '(å…¨ä»¶)'}</h5>
      <p style="font-size:0.7em; color:#999; margin: -5px 0 10px 0;">æ›²åã‚¿ãƒƒãƒ—ã§è©³ç´°å±¥æ­´ã‚’è¡¨ç¤º</p>
      <div class="stats-list">
        ${songsToShow.map(([id, data], i) => `
          <div class="stat-row-group">
            <div class="stat-row" onclick="alertSongHistory('${id}')">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${getSongTitle(id)}</span>
              <b class="stat-count">${data.count}å›</b>
            </div>
            <div class="stat-last-date">Last: ${data.lastDate.substring(2).replace(/-/g,'/')} ${data.lastLiveName} @${data.lastVenue}</div>
          </div>
        `).join('')}
      </div>
    </div>`;

  if (sortedSongs.length > 10) {
    html += `<button class="btn-more" onclick="toggleSongStats()">${isSongStatsFull ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ æ›²ã‚’ã‚‚ã£ã¨è¦‹ã‚‹'}</button>`;
  }

  // â‘¡ æœªé­é‡æ›²
  html += `
    <div class="stats-card">
      <h5 style="color:#666;">ğŸ¤ æœªé­é‡ã®æ›² (${unHeardSongs.length})</h5>
      <div class="unheard-scroll-container">
        <div class="unheard-list">
          ${unHeardSongs.map(s => `<div class="unheard-item">${s.title}</div>`).join('')}
        </div>
      </div>
    </div>`;

  // --- â‘¢ ã€ã“ã“ã«è¿½åŠ ã€‘å¹´åˆ¥å‚æˆ¦ã‚°ãƒ©ãƒ• ---
  html += `
    <div class="stats-card" style="margin-top:20px;">
      <h5>ğŸ“… å‚æˆ¦å¹´è¡¨ (1999 - ${currentYear})</h5>
      <div class="yearly-chart-container">
        ${Object.entries(yearlyCounts).reverse().map(([year, count]) => {
          if (count === 0) return ''; // å‚æˆ¦ãªã—ã®å¹´ã¯è¡¨ç¤ºã—ãªã„
          const width = (count / maxYearlyCount) * 100;
          return `
            <div class="chart-row">
              <span class="chart-year">${year}</span>
              <div class="chart-bar-area"><div class="chart-bar" style="width: ${width}%"></div></div>
              <span class="chart-count">${count}å›</span>
            </div>`;
        }).join('')}
      </div>
    </div>`;

  // --- â‘£ éƒ½é“åºœçœŒã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ ---
  html += `
    <div class="stats-card" style="margin-top:10px; background: #fff9f9; border: 1px solid var(--primary);">
      <h5>ğŸ—ºï¸ 47éƒ½é“åºœçœŒã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h5>
      <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 5px;">
        <b>åˆ¶è¦‡ç‡: ${conquestRate}%</b>
        <span>ã‚ã¨ <b>${47 - visitedCount}</b> çœŒ</span>
      </div>
      <div style="background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 12px;">
        <div style="background: var(--primary); width: ${conquestRate}%; height: 100%;"></div>
      </div>
      <div class="stats-list">
        ${prefsToShow.map(([pref, data], i) => `
          <div class="stat-row-group">
            <div class="stat-row" onclick="alertPrefHistory('${pref}')">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${pref}</span>
              <b class="stat-count">${data.count}å›</b>
            </div>
            <div class="stat-last-date">Last: ${data.lastDate.substring(2).replace(/-/g,'/')} ${data.lastLiveName} @${data.lastVenue}</div>
          </div>
        `).join('')}
      </div>
    </div>`;

  if (sortedPrefs.length > 10) {
    html += `<button class="btn-more" onclick="togglePrefStats()">${isPrefStatsFull ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ éƒ½é“åºœçœŒã‚’ã‚‚ã£ã¨è¦‹ã‚‹'}</button>`;
  }

  document.getElementById('my-stats-area').innerHTML = html;
}



// éƒ½é“åºœçœŒã®å±¥æ­´ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
function alertPrefHistory(prefName) {
  const history = masterLives
    .filter(l => userData.attendedIds.includes(l.id) && (l.pref === prefName || l.prefecture === prefName || l.area === prefName))
    .map(l => `${l.date} ${l.title} @${l.venue}`);
  
  if (history.length > 0) {
    alert(`ã€${prefName}ã€‘ã®å‚æˆ¦å±¥æ­´ (${history.length}å›)\n\n${history.sort().reverse().join('\n')}`);
  }
}



function alertSongHistory(songId) {
  const songTitle = getSongTitle(songId);
  const history = [];

  // å…¨ã¦ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã€ãã®æ›²ãŒå«ã¾ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ã‚’æ¢ã™
  Object.entries(userData.customSetlists).forEach(([liveId, songIds]) => {
    // songIdsã®ä¸­èº«ãŒæ•°å€¤ã®å ´åˆã‚‚ã‚ã‚‹ã®ã§ã€Stringã§æ¯”è¼ƒ
    if (songIds.some(sid => String(sid) === String(songId))) {
      const live = masterLives.find(l => String(l.id) === String(liveId));
      if (live) {
        history.push(`${live.date} ${live.title} @${live.venue}`);
      }
    }
  });

  if (history.length > 0) {
    // æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã¦è¡¨ç¤º
    const message = history.sort().reverse().join('\n');
    alert(`ã€${songTitle}ã€‘ã®å‚æˆ¦å±¥æ­´ (${history.length}å›)\n\n${message}`);
  } else {
    alert('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
  }
}



  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup.json`;
    a.click();
  }

  function importBackup(input) {
    const reader = new FileReader();
    reader.onload = () => { userData = JSON.parse(reader.result); saveUserData(); alert("å¾©å…ƒå®Œäº†"); };
    reader.readAsText(input.files[0]);
  }

  init();
</script>

</body>
</html>
