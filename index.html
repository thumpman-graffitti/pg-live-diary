<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>
  <style>
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ç¶™æ‰¿ */
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }
/* è¨­å®šãƒšãƒ¼ã‚¸ãƒ»çµ±è¨ˆãƒšãƒ¼ã‚¸ã®å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.card {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid #eee;
  margin-bottom: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column; /* è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
  gap: 12px; /* è¦ç´ é–“ã®éš™é–“ã‚’ä¸€å®šã«ã™ã‚‹ */
}

/* è¨­å®šé …ç›®ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ– */
.setting-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.setting-label {
  font-weight: bold;
  font-size: 1em;
  color: #333;
}

.setting-desc {
  font-size: 0.85em;
  color: #666;
  line-height: 1.4;
}

/* ãƒœã‚¿ãƒ³ã‚’ç”»é¢å¹…ã„ã£ã±ã„ã« */
.btn-setting {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-export { background: #444; color: white; }
.btn-import-trigger { background: #eee; color: #333; border: 1px solid #ddd; }

/* çµ±è¨ˆç”¨ï¼šæœªè´æ›²ã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */
.unheard-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* 2åˆ—ã§ä¸¦ã¹ã‚‹ */
  gap: 6px;
  max-height: 250px;
  overflow-y: auto;
  background: #fdfdfd;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #eee;
}

.unheard-item {
  font-size: 0.75em;
  padding: 6px;
  background: white;
  border: 1px solid #efefef;
  border-radius: 4px;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

    
        
            
                


.setting-item {
  margin-bottom: 25px;
}



/* ãƒœã‚¿ãƒ³ã®æ´—ç·´ */
.btn-primary {
  width: 100%;
  padding: 14px;
  background: #444;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 0.95em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: background 0.2s;
}

.btn-primary:active {
  background: #222;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
.file-input-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
  width: 100%;
}

input[type="file"] {
  width: 100%;
  padding: 10px;
  background: #f8f8f8;
  border: 1px dashed #ccc;
  border-radius: 8px;
  font-size: 0.85em;
}
   
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    .my-log-card { display: block !important; padding: 10px 12px !important; margin-bottom: 8px !important; background: white; border-radius: 6px; border: 1px solid #ddd; }
    .log-title-row { display: flex; align-items: baseline; gap: 8px; }
    .log-date { font-size: 0.8em; color: #888; }
    .log-title { font-weight: bold; color: var(--primary); }
    .log-actions { display: flex; gap: 5px; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 8px; }
    .setlist-collapse { display: none; background: #fdfdfd; margin-top: 8px; padding: 8px; font-size: 0.85em; border-left: 2px solid #ccc; }
    .setlist-collapse.open { display: block; }
    .stats-summary-header { background: #333; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; }
    .stats-card { background: white; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .stat-row { display: flex; align-items: center; font-size: 0.85em; padding: 4px 0; }
    .stat-name { flex: 1; color: var(--primary); text-decoration: underline; }
    .unheard-scroll-container { max-height: 150px; overflow-y: auto; background: #fafafa; padding: 8px; }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ç”¨è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .editor-header-sticky { position: sticky; top: -20px; background: white; z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #eee; }
    .setlist-scroll-area { max-height: 50vh; overflow-y: auto; margin-top: 10px; }
    .song-select-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; }
    .song-select-item.selected { background: #fff0f0; }
    .song-index-label { width: 30px; font-size: 0.8em; color: var(--primary); font-weight: bold; }
    .song-title-text { flex: 1; font-size: 0.9em; }
    .song-number-badge { background: var(--primary); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; }
/* çµ±è¨ˆãƒ»ã‚°ãƒ©ãƒ•ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.stat-ranking-item { background: white; border-bottom: 1px solid #eee; padding: 10px; }
.stat-ranking-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.stat-rank-num { font-weight: bold; width: 30px; color: var(--primary); }
.stat-song-info { flex: 1; }
.stat-song-title { font-weight: bold; font-size: 1em; }
.stat-latest-info { font-size: 0.75em; color: #888; margin-top: 2px; }
.stat-count-badge { background: #eee; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
.stat-details-list { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; background: #fafafa; padding: 10px; border-radius: 5px; }
.stat-details-list.open { display: block; }
.detail-row { font-size: 0.8em; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 2px; }

/* ã‚°ãƒ©ãƒ•ç”¨ */
.graph-container { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
.graph-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.8em; }
.graph-label { width: 40px; text-align: right; margin-right: 8px; color: #555; }
.graph-bar-area { flex: 1; background: #f0f0f0; height: 16px; border-radius: 4px; overflow: hidden; }
.graph-bar { height: 100%; background: var(--primary); }
.graph-val { margin-left: 6px; width: 25px; font-weight: bold; color: #333; }

/* ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ */
.btn-show-more { width: 100%; padding: 10px; background: #eee; border: none; color: #555; margin-top: 10px; cursor: pointer; border-radius: 5px; }
.hidden-rank-item { display: none; }

    </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary3</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list"></div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  
  <div id="stats-total-lives" class="stats-summary-header"></div>

  <h4>ğŸ¤ è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="stats-song-ranking" class="stats-card" style="padding:0; overflow:hidden;"></div>
  <button id="btn-more-songs" class="btn-show-more" onclick="showMoreRanking('song')">ã‚‚ã£ã¨è¦‹ã‚‹ (21ä½ä»¥ä¸‹)</button>

  <h4>ğŸš« ã¾ã è´ã„ã¦ã„ãªã„æ›²</h4>
  <div id="stats-unheard-list" class="stats-card unheard-scroll-container"></div>

  <h4>ğŸ“… å¹´åˆ¥å‚åŠ æ•° (1999ã€œ)</h4>
  <div id="stats-year-graph" class="graph-container"></div>

  <h4>ğŸ“ ä¼šå ´ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="stats-venue-ranking" class="stats-card" style="padding:0; overflow:hidden;"></div>
  <button id="btn-more-venues" class="btn-show-more" onclick="showMoreRanking('venue')">ã‚‚ã£ã¨è¦‹ã‚‹ (21ä½ä»¥ä¸‹)</button>
</div>

<div id="tab-settings" class="tab-content">
  <h3 style="padding-left:5px;">è¨­å®š</h3>
  
  <div class="card">
    <div class="setting-group">
      <div class="setting-label">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
      <div class="setting-desc">ç¾åœ¨ã®ã™ã¹ã¦ã®å‚æˆ¦å±¥æ­´ã¨ã‚»ãƒˆãƒªã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</div>
      <button class="btn-setting btn-export" onclick="exportBackup()">
        ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
      </button>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

    <div class="setting-group">
      <div class="setting-label">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ (ãƒªã‚¹ãƒˆã‚¢)</div>
      <div class="setting-desc">ä»¥å‰ä¿å­˜ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br><b style="color:var(--primary);">â€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</b></div>
      <input type="file" id="import-file" accept=".json" onchange="importBackup(this)" 
             style="width:100%; font-size:0.8em; padding:8px; background:#f9f9f9; border-radius:5px; border:1px solid #ddd;">
    </div>
  </div>

  <div style="text-align:center; color:#bbb; font-size:0.75em; margin-top:40px;">
    PG Live Diary v2.1
  </div>
</div>




<div id="edit-modal">
  <div class="modal-content">
    <div class="editor-header-sticky">
      <h3 id="modal-live-title" style="margin:0 0 10px 0; font-size:1.1em;"></h3>
      <input type="text" id="song-filter" placeholder="æ›²åãƒ»ãƒ«ãƒ“ã§æ¤œç´¢..." oninput="renderMasterSongList()">
    </div>
    
    <div id="master-song-select-area" class="setlist-scroll-area">
      </div>

    <div style="margin-top:15px; display:flex; gap:10px;">
      <button onclick="saveCheckedSetlist()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
      <button onclick="closeModal()" style="padding:12px; background:#ccc; border:none; border-radius:5px;">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let currentLiveId = null;
  let tempSelectedSongs = [];

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) {
      console.error("Load Error:", e);
      document.getElementById('master-live-list').innerHTML = "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
    }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
  }

  function renderAll() {
    renderMainLiveList();
    renderMyHistory();
    renderMyStats();
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }

  // --- 1. æ¢ã™ã‚¿ãƒ– ---
  function renderMainLiveList() {
    const container = document.getElementById('master-live-list');
    const grouped = {};
    masterLives.forEach(l => {
      const year = l.date.substring(0, 4);
      if (!grouped[year]) grouped[year] = {};
      if (!grouped[year][l.title]) grouped[year][l.title] = [];
      grouped[year][l.title].push(l);
    });

    let html = "";
    Object.keys(grouped).sort((a,b) => b-a).forEach(year => {
      html += `<div class="year-section"><div class="year-label">${year}</div>`;
      Object.keys(grouped[year]).forEach(tourTitle => {
        const livesInTour = grouped[year][tourTitle];
        html += `
          <div class="tour-group">
            <div class="tour-header" onclick="this.nextElementSibling.classList.toggle('open')">
              <span>${tourTitle}</span>
              <span style="font-size:0.8em; color:#888;">${livesInTour.length}å…¬æ¼” â–¾</span>
            </div>
            <div class="tour-body">
              ${livesInTour.map(l => {
                const isAttended = userData.attendedIds.includes(String(l.id));
                return `
                  <div class="card">
                    <div class="live-info">
                      <span class="live-date">${l.date.substring(5)}</span>
                      <span>${l.venue}</span>
                    </div>
                    <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'}" onclick="toggleAttend('${l.id}')">
                      ${isAttended ? 'âœ…' : 'ï¼‹'}
                    </button>
                  </div>`;
              }).join('')}
            </div>
          </div>`;
      });
      html += `</div>`;
    });
    container.innerHTML = html;
  }

  function toggleAttend(id) {
    const idStr = String(id);
    const index = userData.attendedIds.indexOf(idStr);
    if (index > -1) {
      if (confirm("è§£é™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆã‚»ãƒˆãƒªæƒ…å ±ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰")) {
        userData.attendedIds.splice(index, 1);
        delete userData.customSetlists[idStr];
      }
    } else {
      userData.attendedIds.push(idStr);
    }
    saveUserData();
    renderAll();
  }

  // --- 2. å±¥æ­´ã‚¿ãƒ– ---
  function renderMyHistory() {
    const container = document.getElementById('my-history-list');
    const myLives = masterLives.filter(l => userData.attendedIds.includes(String(l.id)));
    
    // çµ±è¨ˆãƒˆãƒƒãƒ—ã®æ•°å­—æ›´æ–°
    document.getElementById('stats-total-lives').textContent = `Total Lives: ${myLives.length} å›å‚æˆ¦`;

    if (myLives.length === 0) {
      container.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>å‚æˆ¦å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }

    container.innerHTML = myLives.map(l => {
      const setlist = userData.customSetlists[String(l.id)] || [];
      return `
        <div class="card my-log-card">
          <div class="log-title-row">
            <span class="log-date">${l.date}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div style="font-size:0.85em;">${l.venue}</div>
          <div class="log-actions">
            <button class="btn-mini" onclick="document.getElementById('sv-${l.id}').classList.toggle('open')">ğŸ“Š ã‚»ãƒˆãƒª (${setlist.length})</button>
            <button class="btn-mini" style="background:#666; color:white;" onclick="openSetlistEditor('${l.id}')">âœï¸ ç·¨é›†</button>
          </div>
          <div id="sv-${l.id}" class="setlist-collapse">
            ${setlist.length > 0 ? setlist.map((sid, i) => `<div>${i+1}. ${getSongTitle(sid)}</div>`).join('') : 'æœªç™»éŒ²'}
          </div>
        </div>`;
    }).join('');
  }

  // --- 3. çµ±è¨ˆã‚¿ãƒ–ï¼ˆã”è¦æœ›ã®å…¨æ©Ÿèƒ½å®Ÿè£…ï¼‰ ---
  function renderMyStats() {
    // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    const songCounts = {}; // { songId: { count: 0, lives: [] } }
    const venueCounts = {}; // { venueName: { count: 0, lives: [] } }
    const yearCounts = {}; // { year: count }

    // åˆæœŸåŒ–: å¹´ã”ã¨ã®æ ã‚’ä½œã‚‹(1999ã€œç¾åœ¨)
    const currentYear = new Date().getFullYear();
    for (let y = 1999; y <= currentYear; y++) yearCounts[y] = 0;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
    userData.attendedIds.forEach(liveId => {
      const live = masterLives.find(l => String(l.id) === String(liveId));
      if (!live) return;

      // å¹´åˆ¥
      const y = live.date.substring(0, 4);
      if (yearCounts[y] !== undefined) yearCounts[y]++;

      // ä¼šå ´åˆ¥ï¼ˆå˜ç´”ã«ä¼šå ´åã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼‰
      if (!venueCounts[live.venue]) venueCounts[live.venue] = { count: 0, lives: [] };
      venueCounts[live.venue].count++;
      venueCounts[live.venue].lives.push(live);

      // æ›²åˆ¥
      const setlist = userData.customSetlists[liveId] || [];
      setlist.forEach(sid => {
        if (!songCounts[sid]) songCounts[sid] = { count: 0, lives: [] };
        songCounts[sid].count++;
        songCounts[sid].lives.push(live);
      });
    });

    // --- A. è´ã„ãŸæ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
    const sortedSongs = Object.keys(songCounts).map(sid => {
      const data = songCounts[sid];
      // æ—¥ä»˜é™é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒå…ˆé ­ï¼‰
      data.lives.sort((a,b) => new Date(b.date) - new Date(a.date));
      return { id: sid, ...data };
    }).sort((a, b) => b.count - a.count);

    const songHtml = sortedSongs.map((item, idx) => {
      const song = masterSongs.find(s => String(s.id) === String(item.id));
      const latest = item.lives[0]; // æœ€æ–°ãƒ©ã‚¤ãƒ–
      const hideClass = idx >= 20 ? 'hidden-rank-item song-hidden' : '';
      
      const detailsHtml = item.lives.map(l => 
        `<div class="detail-row">${l.date} : ${l.title} (${l.venue})</div>`
      ).join('');

      return `
        <div class="stat-ranking-item ${hideClass}">
          <div class="stat-ranking-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="stat-rank-num">${idx+1}</div>
            <div class="stat-song-info">
              <div class="stat-song-title">${song ? song.title : 'ä¸æ˜'}</div>
              <div class="stat-latest-info">
                æœ€å¾Œã®æ¼”å¥: ${latest.date}<br>
                ${latest.title} @ ${latest.venue}
              </div>
            </div>
            <div class="stat-count-badge">${item.count}å›</div>
          </div>
          <div class="stat-details-list">
            <strong>æ¼”å¥å±¥æ­´:</strong>
            ${detailsHtml}
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('stats-song-ranking').innerHTML = songHtml || '<div style="padding:10px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    document.getElementById('btn-more-songs').style.display = sortedSongs.length > 20 ? 'block' : 'none';

    // --- B. æœªè´æ›²ãƒªã‚¹ãƒˆ ---
    const heardIds = new Set(Object.keys(songCounts));
    const unheard = masterSongs.filter(s => !heardIds.has(String(s.id)));
    document.getElementById('stats-unheard-list').innerHTML = unheard.map(s => 
      `<div style="padding:4px 0; border-bottom:1px solid #eee;">${s.title}</div>`
    ).join('');

    // --- C. å¹´åˆ¥ã‚°ãƒ©ãƒ• ---
    const maxVal = Math.max(...Object.values(yearCounts), 1);
    const graphHtml = Object.keys(yearCounts).map(year => {
      const val = yearCounts[year];
      const width = (val / maxVal) * 100;
      return `
        <div class="graph-row">
          <div class="graph-label">${year}</div>
          <div class="graph-bar-area">
            <div class="graph-bar" style="width: ${width}%;"></div>
          </div>
          <div class="graph-val">${val}</div>
        </div>
      `;
    }).join('');
    document.getElementById('stats-year-graph').innerHTML = graphHtml;

    // --- D. ä¼šå ´ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
    const sortedVenues = Object.keys(venueCounts).map(v => {
      return { name: v, ...venueCounts[v] };
    }).sort((a,b) => b.count - a.count);

    const venueHtml = sortedVenues.map((item, idx) => {
      const hideClass = idx >= 20 ? 'hidden-rank-item venue-hidden' : '';
      const detailsHtml = item.lives.map(l => 
        `<div class="detail-row">${l.date} : ${l.title}</div>`
      ).join('');

      return `
        <div class="stat-ranking-item ${hideClass}">
          <div class="stat-ranking-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="stat-rank-num">${idx+1}</div>
            <div class="stat-song-info">
              <div class="stat-song-title">${item.name}</div>
            </div>
            <div class="stat-count-badge">${item.count}å›</div>
          </div>
          <div class="stat-details-list">
            <strong>å‚åŠ å±¥æ­´:</strong>
            ${detailsHtml}
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('stats-venue-ranking').innerHTML = venueHtml || '<div style="padding:10px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    document.getElementById('btn-more-venues').style.display = sortedVenues.length > 20 ? 'block' : 'none';
  }

  function showMoreRanking(type) {
    const selector = type === 'song' ? '.song-hidden' : '.venue-hidden';
    document.querySelectorAll(selector).forEach(el => {
      el.classList.remove('hidden-rank-item');
    });
    document.getElementById(type === 'song' ? 'btn-more-songs' : 'btn-more-venues').style.display = 'none';
  }

  function getSongTitle(id) {
    const s = masterSongs.find(m => String(m.id) === String(id));
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  // --- ã‚»ãƒˆãƒªç·¨é›†ç”¨ ---
  function openSetlistEditor(liveId) {
    currentLiveId = String(liveId);
    const live = masterLives.find(l => String(l.id) === currentLiveId);
    tempSelectedSongs = userData.customSetlists[currentLiveId] ? [...userData.customSetlists[currentLiveId]] : [];
    
    document.getElementById('modal-live-title').textContent = live ? live.title : "ã‚»ãƒˆãƒªç·¨é›†";
    document.getElementById('song-filter').value = "";
    document.getElementById('edit-modal').style.display = 'block';
    renderMasterSongList();
  }

  function renderMasterSongList() {
    const area = document.getElementById('master-song-select-area');
    const query = document.getElementById('song-filter').value.toLowerCase();
    
    let filtered = masterSongs.filter(s => 
      (s.title || "").toLowerCase().includes(query) || (s.ruby || "").toLowerCase().includes(query)
    );
    filtered.sort((a,b) => (a.ruby || a.title).localeCompare(b.ruby || b.title, 'ja'));

    let lastChar = "";
    area.innerHTML = filtered.map(s => {
      const idStr = String(s.id);
      const selIdx = tempSelectedSongs.indexOf(idStr);
      let indexDisplay = "";
      const curChar = (s.ruby || s.title || "#").charAt(0).toUpperCase();
      if (curChar !== lastChar) { indexDisplay = curChar; lastChar = curChar; }

      return `
        <div class="song-select-item ${selIdx > -1 ? 'selected' : ''}" onclick="toggleSongSelection('${idStr}')">
          <div class="song-index-label">${indexDisplay}</div>
          <div class="song-title-text">${s.title}</div>
          <div>${selIdx > -1 ? `<div class="song-number-badge">${selIdx+1}</div>` : 'â—‹'}</div>
        </div>`;
    }).join('');
  }

  function toggleSongSelection(id) {
    const idx = tempSelectedSongs.indexOf(id);
    if (idx > -1) tempSelectedSongs.splice(idx, 1);
    else tempSelectedSongs.push(id);
    renderMasterSongList();
  }

  function saveCheckedSetlist() {
    userData.customSetlists[currentLiveId] = [...tempSelectedSongs];
    saveUserData();
    renderAll();
    closeModal();
  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  // --- è¨­å®šï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ï¼‰ ---
  function exportBackup() {
    const dataStr = JSON.stringify(userData);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pg_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  }

  function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const imported = JSON.parse(event.target.result);
        if (imported.attendedIds) {
          userData = imported;
          saveUserData();
          renderAll();
          alert("å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼");
        } else {
          alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
      } catch (err) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };
    reader.readAsText(file);
  }

  init();
</script>


</body>
</html>
