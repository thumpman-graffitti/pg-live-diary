<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PG Live Diary</title>
  <style>
    :root { --primary: #e60012; --bg: #f4f4f4; --text: #333; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: var(--text); }
    header { background: #333; color: white; padding: 15px; text-align: center; }
    .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
    .tab-content.active { display: block; }
    
    /* å¹´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .year-section { margin-top: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
    .year-label { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #555; }

    /* ãƒ„ã‚¢ãƒ¼åˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
    .tour-group { margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
    .tour-header { background: #fff; padding: 12px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .tour-body { display: none; background: #fafafa; }
    .tour-body.open { display: block; }

    /* ãƒ©ã‚¤ãƒ–é …ç›®ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .card { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
    .card:last-child { border-bottom: none; }
    .live-info { font-size: 0.9em; }
    .live-date { color: #888; font-size: 0.8em; margin-right: 5px; }

    /* å°ã•ã„ãƒœã‚¿ãƒ³ */
    .btn-mini { border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; }
    .btn-add { background: #eee; color: #666; }
    .btn-del { background: var(--primary); color: white; }
    .btn-edit { background: #007bff; color: white; width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 100; }
    nav button { flex: 1; padding: 15px; border: none; background: none; font-size: 12px; }
    nav button.active { color: var(--primary); font-weight: bold; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; overflow-y: auto; }
    .modal-content { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; }
    
    /* iPhoneã‚ºãƒ¼ãƒ å¯¾ç­–ï¼šãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’16pxä»¥ä¸Šã«è¨­å®š */
    #song-search {
      font-size: 16px !important;
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .song-item { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #eee; align-items: center; }

/* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.my-log-card {
  display: block !important; /* flexã‹ã‚‰å¤‰æ›´ */
  padding: 10px 12px !important;
  margin-bottom: 8px !important;
  background: white;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.log-title-row {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 2px;
}

.log-date { font-size: 0.8em; color: #888; font-family: monospace; }
.log-title { font-weight: bold; font-size: 1em; color: var(--primary); flex: 1; }
.log-venue { font-size: 0.85em; color: #333; margin-bottom: 8px; }

/* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
.log-actions {
  display: flex;
  gap: 5px;
  border-top: 1px dashed #eee;
  padding-top: 8px;
}

.btn-view-setlist { background: #f0f0f0; color: #333; flex: 2; }
.btn-edit-icon { background: #666; color: white; flex: 1; }

/* ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®æŠ˜ã‚ŠãŸãŸã¿ */
.setlist-collapse {
  display: none;
  background: #fdfdfd;
  margin-top: 8px;
  padding: 8px;
  border-radius: 4px;
  font-size: 0.85em;
  color: #555;
  border-left: 2px solid #ccc;
  line-height: 1.5;
}

.setlist-collapse.open {
  display: block;
}        
  </style>
</head>
<body>

<header><h1>ğŸ¸ PG Live Diary</h1></header>

<div id="tab-search" class="tab-content active">
  <div id="master-live-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="tab-my-log" class="tab-content">
  <h3>ãƒã‚¤å‚æˆ¦å±¥æ­´</h3>
  <div id="my-history-list">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="tab-stats" class="tab-content">
  <h3>ãƒã‚¤çµ±è¨ˆ</h3>
  <div id="my-stats-area"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h3>è¨­å®š</h3>
  <button class="btn-edit" onclick="exportBackup()" style="background:#666;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
  <div style="margin-top:20px;">
    <label style="font-size: 0.9em; color: #666;">ãƒªã‚¹ãƒˆã‚¢ï¼š</label>
    <input type="file" onchange="importBackup(this)">
  </div>
</div>

<div id="edit-modal">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <div id="current-setlist"></div>
    <hr>
    <h4>æ›²ã‚’è¿½åŠ </h4>
    <input type="text" id="song-search" placeholder="æ›²åã‚’æ¤œç´¢..." oninput="searchSongs(this.value)">
    <div id="search-results" style="max-height: 250px; overflow-y: auto;"></div>
    <button class="btn-mini" onclick="closeModal()" style="background:#333; color:white; width:100%; padding:10px; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<nav id="bottom-nav">
  <button onclick="showTab('search')" id="nav-search" class="active">æ¢ã™</button>
  <button onclick="showTab('my-log')" id="nav-my-log">å±¥æ­´</button>
  <button onclick="showTab('stats')" id="nav-stats">çµ±è¨ˆ</button>
  <button onclick="showTab('settings')" id="nav-settings">è¨­å®š</button>
</nav>

<script>
  let masterLives = [];
  let masterSongs = [];
  let userData = { attendedIds: [], customSetlists: {} };
  let editingLiveId = null;

  async function init() {
    try {
      const [resLives, resSongs] = await Promise.all([
        fetch('lives.json').then(r => r.json()),
        fetch('songs_master.json').then(r => r.json())
      ]);
      masterLives = resLives.sort((a, b) => new Date(b.date) - new Date(a.date));
      masterSongs = resSongs;
      loadUserData();
      renderAll();
    } catch (e) { console.error(e); }
  }

  function loadUserData() {
    const saved = localStorage.getItem('pg_user_diary');
    if (saved) userData = JSON.parse(saved);
  }

  function saveUserData() {
    localStorage.setItem('pg_user_diary', JSON.stringify(userData));
    renderAll();
  }

  function renderAll() {
    renderMasterList();
    renderMyHistory();
    renderMyStats();
  }


function renderMasterList() {
  const container = document.getElementById('master-live-list');
  const years = {};

  masterLives.forEach(l => {
    const year = l.date.substring(0, 4);
    if (!years[year]) years[year] = {};
    if (!years[year][l.title]) years[year][l.title] = [];
    years[year][l.title].push(l);
  });

  const sortedYears = Object.keys(years).sort((a, b) => b - a);

  container.innerHTML = sortedYears.map(year => `
    <div class="year-section">
      <div class="year-label">${year}å¹´</div>
      ${Object.keys(years[year]).map(title => `
        <div class="tour-group">
          <div class="tour-header" onclick="toggleTour(event, this)">
            <span>${title}</span>
            <span style="font-size:0.7em; color:#999; pointer-events:none;">â–¼</span>
          </div>
          <div class="tour-body">
            ${years[year][title].map(live => {
              const isAttended = userData.attendedIds.includes(live.id);
              return `
                <div class="card">
                  <div class="live-info">
                    <span class="live-date">${live.date.substring(5).replace('-', '/')}</span>
                    <span>${live.venue}</span>
                  </div>
                  <button class="btn-mini ${isAttended ? 'btn-del' : 'btn-add'} js-attend-btn" 
                          data-id="${live.id}"
                          onclick="handleToggleAttend(event, '${live.id}')">
                    ${isAttended ? 'âœ…' : 'ï¼‹'}
                  </button>
                </div>`;
            }).join('')}
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function toggleTour(event, header) {
  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯çµ¶å¯¾ã«å‹•ã‹ã•ãªã„
  if (event.target.closest('button')) return;
  
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}




// ãƒœã‚¿ãƒ³ã«ç›´æ¥ã€Œã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç„¡è¦–ã™ã‚‹ã€è¨­å®šã‚’æµã—è¾¼ã‚€
function attachButtonEvents() {
  const btns = document.querySelectorAll('.js-attend-btn');
  btns.forEach(btn => {
    btn.onclick = function(e) {
      // 1. è¦ªã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼é”ã‚’å¾¹åº•çš„ã«æ‹’å¦
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const liveId = this.getAttribute('data-id');
      toggleAttend(liveId);
      
      // 2. ã“ã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ false ã«ã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®é€£é–ã‚’æ­¢ã‚ã‚‹
      return false;
    };
  });
}

// ã“ã¡ã‚‰ã®é–¢æ•°ã‚‚ã“ã‚Œã ã‘ã«ç°¡ç•¥åŒ–
function handleToggleAttend(event, id) {
  // HTMLå´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã“ã¨ã¯ãªããªã‚Šã¾ã™ãŒã€å®šç¾©ã ã‘æ®‹ã—ã¦ãŠãã¾ã™
  if (event) event.stopPropagation();
  toggleAttend(id);
}

function toggleAttend(id) {
  // 1. ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
  const index = userData.attendedIds.indexOf(id);
  if (index > -1) {
    const live = masterLives.find(l => l.id == id);
    const hasSetlist = userData.customSetlists[id] && userData.customSetlists[id].length > 0;
    let message = `ã€Œ${live.venue}ã€ã®å‚æˆ¦ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    if (hasSetlist) message += "\nâ€»ç™»éŒ²æ¸ˆã¿ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
    
    if (!confirm(message)) return;

    userData.attendedIds.splice(index, 1);
    delete userData.customSetlists[id];
  } else {
    userData.attendedIds.push(id);
  }

  // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆrenderAllã¯å‘¼ã°ãªã„ï¼‰
  localStorage.setItem('pg_user_diary', JSON.stringify(userData));

  // 3. ã€é‡è¦ã€‘ç”»é¢å…¨ä½“ã‚’å†æç”»ã›ãšã€æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã ã‘ã‚’æ›¸ãæ›ãˆã‚‹
  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn) {
    const isAttended = userData.attendedIds.includes(id);
    btn.className = `btn-mini ${isAttended ? 'btn-del' : 'btn-add'} js-attend-btn`;
    btn.innerHTML = isAttended ? 'âœ…' : 'ï¼‹';
  }
  
  // 4. ä»–ã®ã‚¿ãƒ–ï¼ˆå±¥æ­´ã‚„çµ±è¨ˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚è£ã§æ›´æ–°ã—ã¦ãŠã
  renderMyHistory();
  renderMyStats();
}

function renderMyHistory() {
  const container = document.getElementById('my-history-list');
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  
  if (myLives.length === 0) {
    container.innerHTML = "ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  container.innerHTML = myLives.map(l => {
    const setlist = userData.customSetlists[l.id] || [];
    return `
      <div class="card my-log-card">
        <div class="log-main-info">
          <div class="log-title-row">
            <span class="log-date">${l.date.substring(2).replace(/-/g, '/')}</span>
            <span class="log-title">${l.title}</span>
          </div>
          <div class="log-venue">${l.venue}</div>
        </div>
        
        <div class="log-actions">
          <button class="btn-mini btn-view-setlist" onclick="toggleSetlistDisplay('${l.id}')">
            ğŸ“Š ã‚»ãƒˆãƒª ${setlist.length > 0 ? `(${setlist.length})` : ''}
          </button>
          <button class="btn-mini btn-edit-icon" onclick="openEditModal('${l.id}')">âœï¸ ç·¨é›†</button>
        </div>

        <div id="setlist-view-${l.id}" class="setlist-collapse">
          <div class="setlist-content">
            ${setlist.length > 0 
              ? setlist.map((s, i) => `<div>${i+1}. ${getSongTitle(s)}</div>`).join('')
              : '<span style="color:#999;">ã‚»ãƒˆãƒªæœªç™»éŒ²</span>'}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°ï¼ˆæ–°è¨­ï¼‰
function toggleSetlistDisplay(id) {
  const el = document.getElementById(`setlist-view-${id}`);
  el.classList.toggle('open');
}

 

  function getSongTitle(songId) {
    const s = masterSongs.find(sm => sm.id == songId);
    return s ? s.title : "ä¸æ˜ãªæ›²";
  }

  function openEditModal(liveId) {
    editingLiveId = liveId;
    const live = masterLives.find(l => l.id == liveId);
    document.getElementById('modal-title').textContent = live.date + " ã‚»ãƒˆãƒª";
    renderCurrentSetlist();
    document.getElementById('edit-modal').style.display = 'block';
  }

  function renderCurrentSetlist() {
    const list = userData.customSetlists[editingLiveId] || [];
    document.getElementById('current-setlist').innerHTML = list.map((songId, index) => `
      <div class="song-item">
        <span>${index+1}. ${getSongTitle(songId)}</span>
        <button onclick="removeSong(${index})" style="color:red; border:none; background:none;">å‰Šé™¤</button>
      </div>
    `).join('') || "æœªç™»éŒ²";
  }

  function searchSongs(query) {
    const results = document.getElementById('search-results');
    if (!query) { results.innerHTML = ""; return; }
    const filtered = masterSongs.filter(s => s.title.includes(query)).slice(0, 10);
    results.innerHTML = filtered.map(s => `
      <div class="song-item" onclick="addSong('${s.id}')" style="cursor:pointer; background:#f9f9f9; margin-top:2px;">
        <span>${s.title}</span> <span style="color:blue;">ï¼‹</span>
      </div>
    `).join('');
  }

  function addSong(songId) {
    if (!userData.customSetlists[editingLiveId]) userData.customSetlists[editingLiveId] = [];
    userData.customSetlists[editingLiveId].push(songId);
    renderCurrentSetlist();
    saveUserData();
  }

  function removeSong(index) {
    userData.customSetlists[editingLiveId].splice(index, 1);
    renderCurrentSetlist();
    saveUserData();
  }

  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.add('active');
  }


function renderMyStats() {
  const myLives = masterLives.filter(l => userData.attendedIds.includes(l.id));
  
  // --- 1. æ›²ã®æ¼”å¥å›æ•°é›†è¨ˆ ---
  const songCounts = {};
  Object.values(userData.customSetlists).forEach(list => {
    list.forEach(id => { songCounts[id] = (songCounts[id] || 0) + 1; });
  });
  const sortedSongs = Object.entries(songCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);

  // --- 2. éƒ½é“åºœçœŒã®å‚æˆ¦å›æ•°é›†è¨ˆ ---
  const prefCounts = {};
  myLives.forEach(l => {
    if (l.pref) {
      prefCounts[l.pref] = (prefCounts[l.pref] || 0) + 1;
    }
  });
  const sortedPrefs = Object.entries(prefCounts).sort((a,b) => b[1] - a[1]);

  // --- 3. HTMLã®çµ„ã¿ç«‹ã¦ ---
  let html = `<h4>ğŸ“Š å‚æˆ¦çµ±è¨ˆ</h4>`;

  // éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  html += `<div style="background:white; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd;">
            <h5 style="margin-top:0; color:var(--primary);">ğŸ—ºï¸ éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°</h5>`;
  if (sortedPrefs.length > 0) {
    html += sortedPrefs.map(([pref, count]) => `
      <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9em;">
        <span>${pref}</span>
        <span style="font-weight:bold;">${count}å›</span>
      </div>
    `).join('');
  } else {
    html += `<div style="color:#999; font-size:0.8em;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  }
  html += `</div>`;

  // æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  html += `<div style="background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
            <h5 style="margin-top:0; color:var(--primary);">ğŸµ æ›²åˆ¥ãƒ»ç”Ÿæ¼”å¥é­é‡æ•° (TOP10)</h5>`;
  if (sortedSongs.length > 0) {
    html += sortedSongs.map(([id, count]) => `
      <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9em;">
        <span>${getSongTitle(id)}</span>
        <span style="font-weight:bold;">${count}å›</span>
      </div>
    `).join('');
  } else {
    html += `<div style="color:#999; font-size:0.8em;">ã‚»ãƒˆãƒªã‚’å…¥åŠ›ã™ã‚‹ã¨é›†è¨ˆã•ã‚Œã¾ã™</div>`;
  }
  html += `</div>`;

  document.getElementById('my-stats-area').innerHTML = html;
}


  function exportBackup() {
    const blob = new Blob([JSON.stringify(userData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pg_diary_backup.json`;
    a.click();
  }

  function importBackup(input) {
    const reader = new FileReader();
    reader.onload = () => { userData = JSON.parse(reader.result); saveUserData(); alert("å¾©å…ƒå®Œäº†"); };
    reader.readAsText(input.files[0]);
  }

  init();
</script>

</body>
</html>
